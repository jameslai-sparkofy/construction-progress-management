# 工程進度管理系統 - 架構設計

## 系統架構圖

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     業主端      │     │     工班端      │     │    管理端       │
│   (Browser)     │     │   (Browser)     │     │   (Browser)     │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         └───────────────────────┴───────────────────────┘
                                 │
                                 │ HTTPS
                                 ▼
         ┌───────────────────────────────────────────────┐
         │           Cloudflare Pages                    │
         │         (React/Vue Frontend)                  │
         │  - 響應式設計                                 │
         │  - PWA支援                                    │
         │  - 本地快取                                   │
         └───────────────────────┬───────────────────────┘
                                 │
                                 │ API Calls
                                 ▼
         ┌───────────────────────────────────────────────┐
         │         Cloudflare Workers                    │
         │         (API Gateway Layer)                   │
         │  - 身份驗證 (JWT)                             │
         │  - 權限控制                                   │
         │  - API代理                                    │
         │  - 請求快取                                   │
         └────────┬──────────────┬───────────────────────┘
                  │              │
                  ▼              ▼
    ┌─────────────────────┐  ┌─────────────────────┐
    │  Cloudflare KV      │  │ Cloudflare Queues   │
    │  - Session存儲      │  │  - 通知隊列        │
    │  - 用戶權限快取     │  │  - 批次處理        │
    └─────────────────────┘  └──────────┬──────────┘
                                        │
         ┌──────────────────────────────┴───────────────┐
         │                                              │
         ▼                                              ▼
┌─────────────────────┐                    ┌─────────────────────┐
│   紛享銷客 API      │                    │    簡訊服務 API     │
│  - 維修單管理       │                    │  - OTP驗證          │
│  - 用戶資料         │                    │  - 進度通知         │
│  - 文件上傳         │                    └─────────────────────┘
└─────────────────────┘

```

## 關鍵組件說明

### 1. 前端應用 (Cloudflare Pages)
- **技術棧**: Vue 3 + Vite + Element Plus
- **功能**:
  - 響應式設計，支援手機/平板/電腦
  - PWA功能，可離線瀏覽已快取數據
  - 即時更新（SSE/輪詢）
  - 文件上傳（照片、視頻壓縮）

### 2. API網關 (Cloudflare Workers)
- **主要功能**:
  - 保護API密鑰（環境變數）
  - JWT Token驗證
  - 請求轉發到紛享銷客
  - 響應快取策略
  - Rate limiting

### 3. 數據存儲
- **Cloudflare KV**:
  - Session管理
  - 用戶權限快取
  - 臨時數據存儲
  
- **紛享銷客CRM**:
  - 主要數據源
  - 維修單、案場、用戶資料

### 4. 通知系統
- **Cloudflare Queues**:
  - 異步處理通知
  - 批次發送簡訊
  - 失敗重試機制

## 安全措施

### API密鑰保護流程
```javascript
// 前端請求
fetch('/api/repair-orders', {
  headers: {
    'Authorization': 'Bearer [JWT_TOKEN]'
  }
})

// Workers處理
export default {
  async fetch(request, env) {
    // 驗證JWT
    const token = verifyJWT(request.headers.get('Authorization'))
    
    // 使用環境變數中的API密鑰
    const fxResponse = await fetch('https://open.fxiaoke.com/...', {
      headers: {
        'corpAccessToken': env.FX_API_TOKEN // 從環境變數取得
      }
    })
    
    return new Response(fxResponse)
  }
}
```

## 用戶流程

### 1. 登入流程
```
用戶輸入手機號 → Workers發送OTP → 用戶輸入驗證碼 → 
Workers驗證 → 生成JWT → 返回Token → 前端存儲
```

### 2. 數據查詢流程
```
前端請求(JWT) → Workers驗證身份 → 檢查權限 → 
查詢紛享銷客 → 過濾數據 → 返回結果
```

### 3. 數據更新流程
```
前端提交(JWT) → Workers驗證 → 權限檢查 → 
欄位驗證 → 更新紛享銷客 → 發送通知 → 返回結果
```

## 部署計劃

### Phase 1: 基礎設施（1週）
- [ ] Cloudflare帳號設置
- [ ] Workers環境配置
- [ ] KV命名空間創建
- [ ] 環境變數設置

### Phase 2: 核心功能（2週）
- [ ] 登入系統
- [ ] 基本查詢API
- [ ] 權限控制
- [ ] 前端框架

### Phase 3: 業務功能（2週）
- [ ] 維修單查看/編輯
- [ ] 照片上傳
- [ ] 進度更新
- [ ] 通知系統

### Phase 4: 優化測試（1週）
- [ ] 性能優化
- [ ] 安全測試
- [ ] 用戶測試
- [ ] 上線準備