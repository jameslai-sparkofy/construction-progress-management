# 工程進度管理系統 - 多租戶架構設計

## 核心概念
每個商機（專案）都是一個獨立的「租戶」，擁有：
- 專屬網址（如：xinganxi.yourcompany.com 或 yourcompany.com/xinganxi）
- 獨立的後台管理
- 自定義的欄位權限配置

## 系統架構

```
┌─────────────────────────────────────────────────────────────┐
│                     超級管理後台                              │
│  - 商機管理（創建/刪除網站）                                 │
│  - 全局設定                                                  │
└──────────────────────────┬──────────────────────────────────┘
                          │
┌─────────────────────────┴────────────────────────────────────┐
│                    Cloudflare Workers                         │
│                  (多租戶路由和API網關)                        │
│  - 根據URL path識別商機                                      │
│  - 載入對應商機的配置                                        │
│  - API權限控制                                               │
└─────────────────────────┬────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  商機A網站   │  │  商機B網站   │  │  商機C網站   │
│ 興安西專案   │  │  市鎮南專案  │  │  其他專案    │
├──────────────┤  ├──────────────┤  ├──────────────┤
│ 前台查詢頁面 │  │ 前台查詢頁面 │  │ 前台查詢頁面 │
│ 商機專屬後台 │  │ 商機專屬後台 │  │ 商機專屬後台 │
└──────────────┘  └──────────────┘  └──────────────┘
```

## 網址結構

### 路徑模式（單一網域 + 安全token）
```
progress.yourcompany.com/xinganxi-abc123def456/         # 興安西工程
progress.yourcompany.com/shizhennan-xyz789uvw012/       # 市鎮南工程
progress.yourcompany.com/project-name-random-token/     # 其他工程
```

### URL安全設計
- **格式**：`{專案名稱}-{12位隨機token}`
- **範例**：`xinganxi-abc123def456`
- **安全性**：隨機token防止URL被猜測
- **可讀性**：保留專案名稱便於識別
- **Token生成**：系統自動生成，不可手動修改

## 商機專屬後台功能

### 1. 欄位權限管理
```javascript
// 權限配置示例
{
  "opportunity_id": "650fe201d184e50001102aee",
  "name": "勝興-興安西-2024",
  "field_permissions": {
    "building_type__c": {
      "工班": "view",      // 只能查看
      "業主": "view",      // 只能查看
      "管理員": "edit"     // 可編輯
    },
    "field_JmGkC__c": {    // 維修狀況
      "工班": "edit",      // 可編輯
      "業主": "view",      // 只能查看
      "管理員": "edit"     // 可編輯
    },
    "field_iSwte__c": {    // 簽名
      "工班": "view",      // 只能查看
      "業主": "edit",      // 可編輯（驗收簽名）
      "管理員": "edit"     // 可編輯
    },
    "field_gKt1C__c": {    // 維修金額
      "工班": "hide",      // 不顯示
      "業主": "view",      // 只能查看
      "管理員": "edit"     // 可編輯
    }
  }
}
```

### 2. 後台管理介面
- 欄位權限配置（拖拉式介面）
- 用戶管理（工班/業主名單）
- 查看統計報表
- 匯出資料

## 數據存儲設計

### Cloudflare KV 結構
```
// 商機配置
opportunities:{opportunity_id} = {
  name: "勝興-興安西-2024",
  slug: "xinganxi",
  field_permissions: {...},
  users: {...},
  created_at: "2024-01-01"
}

// 用戶Session
sessions:{token} = {
  user_id: "xxx",
  opportunity_id: "xxx",
  role: "工班",
  expires: timestamp
}

// 商機映射（快速查找）
paths:{slug} = {opportunity_id}
```

## 簡訊服務商推薦

### 1. **Twilio（國際推薦）** ⭐
**優點**：
- API文檔完整，整合簡單
- 全球覆蓋，台灣號碼支援良好
- 價格透明（約 NT$1.5-2/則）
- 有免費測試額度

**缺點**：
- 需要國外信用卡
- 介面是英文

### 2. **三竹資訊（本土首選）** ⭐
**優點**：
- 台灣本土，中文支援
- 到達率高，速度快
- 可開立台灣發票
- 價格實惠（約 NT$0.8-1.2/則）

**缺點**：
- API文檔較舊
- 需要簽約流程

### 3. **詮力科技**
**優點**：
- 台灣公司
- 有企業方案

**缺點**：
- 價格較高
- API功能較少

**建議**：如果要快速開始，用 Twilio；如果要長期使用且需要發票，用三竹。

## 創建新商機網站流程

```
1. 超級管理員登入總後台
   ↓
2. 選擇「創建新商機網站」
   ↓
3. 從紛享銷客選擇商機
   ↓
4. 設定URL路徑（如：xinganxi）
   ↓
5. 初始化權限配置
   ↓
6. 生成專屬網站
   ↓
7. 網站可通過 progress.yourcompany.com/xinganxi 訪問
```

## 實作優先順序

### Phase 1：基礎多租戶架構
1. Workers路由系統
2. 商機識別邏輯
3. 基礎API代理

### Phase 2：商機後台
1. 權限配置介面
2. 用戶管理
3. 基礎報表

### Phase 3：前台功能
1. 登入系統
2. 數據查詢
3. 編輯功能

### Phase 4：超級管理後台
1. 商機管理
2. 批量操作
3. 系統監控