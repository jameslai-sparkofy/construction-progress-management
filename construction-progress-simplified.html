<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡åŒ–æ¬Šé™ç³»çµ± - æ–½å·¥é€²åº¦ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #E0E0E0;
        }

        .header h1 {
            color: #333;
            font-size: 1.6em;
            margin-bottom: 20px;
        }

        .user-info {
            background: #E3F2FD;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9em;
            border-left: 4px solid #1976D2;
        }

        .contractor-selector {
            background: #F8F9FA;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #E0E0E0;
        }

        .contractor-selector h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1em;
        }

        .contractor-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
        }

        .contractor-info {
            margin-top: 10px;
            padding: 10px;
            background: #E8F5E8;
            border-radius: 6px;
            font-size: 0.85em;
            color: #2E7D32;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1976D2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565C0;
        }

        .btn-success {
            background: #388E3C;
            color: white;
        }

        .btn-success:hover {
            background: #2E7D32;
        }

        .btn-secondary {
            background: #757575;
            color: white;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .building-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            background: #E0E0E0;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
            color: #666;
        }

        .tab.active {
            background: #1976D2;
            color: white;
        }

        .tab.readonly {
            background: #FFF3E0;
            color: #E65100;
        }

        .tab:hover:not(.active):not(.readonly) {
            background: #BDBDBD;
        }

        .grid-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #E0E0E0;
            overflow-x: auto;
        }

        .construction-grid {
            min-width: 500px;
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9em;
        }

        .construction-grid th,
        .construction-grid td {
            border: 1px solid #E0E0E0;
            padding: 10px 8px;
            text-align: center;
            position: relative;
        }

        .construction-grid th {
            background: #F5F5F5;
            color: #333;
            font-weight: 600;
            font-size: 0.85em;
        }

        .construction-grid td {
            width: 70px;
            height: 45px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .construction-grid td:hover {
            background: #F0F8FF;
        }

        .construction-grid td.readonly {
            background: #FFF8E1;
            cursor: default;
        }

        .construction-grid td.readonly:hover {
            background: #FFF3C4;
        }

        .construction-grid td.no-permission {
            background: #FAFAFA;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .floor-label {
            background: #E0E0E0 !important;
            color: #333 !important;
            font-weight: 600;
            cursor: default !important;
        }

        .floor-restricted {
            background: #FFEBEE !important;
            color: #C62828 !important;
        }

        /* ç‹€æ…‹é¡è‰² */
        .status-completed { color: #2E7D32; }
        .status-finished { color: #1976D2; }
        .status-ready { color: #F57C00; }
        .status-blocked { color: #D32F2F; }
        .status-repair { color: #7B1FA2; }
        .status-pending { color: #616161; }

        /* Modalæ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 25px;
            min-width: 400px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #E0E0E0;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .role-demo {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .role-demo label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
            font-weight: 500;
            color: #666;
        }

        .role-demo select {
            width: 100%;
            padding: 5px;
            font-size: 0.85em;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .user-actions {
                flex-direction: column;
            }

            .building-tabs {
                flex-direction: column;
            }

            .tab {
                margin-bottom: 5px;
            }

            .role-demo {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ–½å·¥é€²åº¦ç®¡ç†ç³»çµ±</h1>
            
            <div class="user-info" id="userInfo">
                <!-- å‹•æ…‹é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯ -->
            </div>
            
            <!-- å·¥ç­é¸æ“‡å™¨ -->
            <div class="contractor-selector" id="contractorSelector" style="display: none;">
                <h3>é¸æ“‡å·¥ç­</h3>
                <select id="contractorSelect" onchange="switchContractor()">
                    <option value="">è«‹é¸æ“‡å·¥ç­</option>
                    <!-- å‹•æ…‹ç”Ÿæˆå·¥ç­é¸é … -->
                </select>
                <div class="contractor-info" id="contractorInfo" style="display: none;">
                    <!-- é¡¯ç¤ºé¸ä¸­å·¥ç­çš„è² è²¬å€åŸŸ -->
                </div>
            </div>
            
            <div class="user-actions" id="userActions">
                <!-- å‹•æ…‹é¡¯ç¤ºç”¨æˆ¶å¯ç”¨æ“ä½œ -->
            </div>
        </div>

        <!-- å»ºç¯‰é¸æ“‡å’Œç¶²æ ¼ -->
        <div class="grid-container">
            <div class="building-tabs" id="buildingTabs">
                <button class="tab active" onclick="switchBuilding('A')">Aæ£Ÿ</button>
                <button class="tab" onclick="switchBuilding('B')">Bæ£Ÿ</button>
                <button class="tab" onclick="switchBuilding('C')">Cæ£Ÿ</button>
            </div>

            <table class="construction-grid" id="constructionGrid">
                <thead>
                    <tr>
                        <th>æ¨“å±¤/æˆ¶åˆ¥</th>
                        <th>A1</th>
                        <th>A2</th>
                        <th>A3</th>
                        <th>A4</th>
                        <th>A5</th>
                        <th>A6</th>
                    </tr>
                </thead>
                <tbody id="gridBody">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- å‰µå»ºç”¨æˆ¶Modal -->
    <div class="modal" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å‰µå»ºç”¨æˆ¶</h3>
                <button class="close" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>ç”¨æˆ¶é¡å‹ï¼š</label>
                <select id="userType" onchange="updateUserForm()">
                    <option value="contractor_leader">å·¥ç­ä¸»è¦è² è²¬äºº</option>
                    <option value="contractor_member">å·¥ç­æˆå“¡</option>
                    <option value="owner">æ¥­ä¸»</option>
                </select>
            </div>
            <div class="form-group">
                <label>å§“åï¼š</label>
                <input type="text" id="userName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label>é›»è©±ï¼š</label>
                <input type="tel" id="userPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
            </div>
            <div id="contractorFields">
                <div class="form-group">
                    <label>å·¥ç­é¸æ“‡ï¼š</label>
                    <select id="contractorGroupSelect">
                        <option value="">è«‹é¸æ“‡å·¥ç­</option>
                        <!-- å‹•æ…‹ç”Ÿæˆå·¥ç­é¸é … -->
                    </select>
                    <div class="help-text">é¸æ“‡è©²ç”¨æˆ¶æ‰€å±¬çš„å·¥ç­</div>
                </div>
            </div>
            <div id="ownerFields" style="display: none;">
                <div class="form-group">
                    <label>æ¥­ä¸»æ¬Šé™ï¼š</label>
                    <div class="help-text">æ¥­ä¸»å¯ä»¥æŸ¥çœ‹å’Œç·¨è¼¯æ•´å€‹æ¡ˆå ´çš„æ‰€æœ‰è³‡æ–™</div>
                </div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createUser()">å‰µå»º</button>
            </div>
        </div>
    </div>

    <!-- è§’è‰²æ¼”ç¤ºåˆ‡æ›å™¨ -->
    <div class="role-demo">
        <label>æ¼”ç¤ºè§’è‰²åˆ‡æ›ï¼š</label>
        <select id="roleSelect" onchange="switchRole()">
            <option value="admin">ç®¡ç†å“¡</option>
            <option value="contractor_leader">å·¥ç­ä¸»è¦è² è²¬äºº</option>
            <option value="contractor_member">å·¥ç­æˆå“¡</option>
            <option value="owner">æ¥­ä¸»</option>
        </select>
    </div>

    <script>
        // æ¡ˆå ´æ•¸æ“šï¼ˆåŒ…å«å·¥ç­ä¿¡æ¯ï¼‰
        const siteData = {
            site_id: "site123",
            name: "å‹èˆˆ-èˆˆå®‰è¥¿-2023",
            contractors: [
                {
                    id: "contractor_A",
                    name: "ABCå·¥ç¨‹è¡Œ",
                    leader_phone: "17600000001",
                    members: ["17600000002", "17600000003"],
                    assigned_areas: {
                        buildings: ["A"],
                        floors: "all"
                    }
                },
                {
                    id: "contractor_B", 
                    name: "XYZå»ºè¨­",
                    leader_phone: "17600000004",
                    members: ["17600000005"],
                    assigned_areas: {
                        buildings: ["B"],
                        floors: "all"
                    }
                },
                {
                    id: "contractor_C",
                    name: "DEFç‡Ÿé€ ",
                    leader_phone: "17600000006",
                    members: ["17600000007"],
                    assigned_areas: {
                        buildings: ["C"],
                        floors: [1,2,3,4,5]
                    }
                },
                {
                    id: "contractor_D",
                    name: "GHIå·¥ç¨‹",
                    leader_phone: "17600000008",
                    members: ["17600000009"],
                    assigned_areas: {
                        buildings: ["C"],
                        floors: [6,7,8,9,10,11,12,13,14,15,16]
                    }
                }
            ],
            owners: [
                {
                    id: "owner_001",
                    name: "æ¥­ä¸»A",
                    phone: "17700000001"
                },
                {
                    id: "owner_002", 
                    name: "æ¥­ä¸»B",
                    phone: "17700000002"
                }
            ]
        };

        // ç”¨æˆ¶æ¬Šé™é…ç½®
        const userProfiles = {
            admin: {
                name: "ç³»çµ±ç®¡ç†å“¡",
                role: "admin",
                permissions: { can_edit_all: true, can_view_all: true, can_create_users: true }
            },
            contractor_leader: {
                name: "å·¥ç­ä¸»è¦è² è²¬äºº",
                role: "contractor_leader",
                contractor_id: null, // éœ€è¦é¸æ“‡å·¥ç­
                permissions: { can_edit_own: true, can_view_own: true, can_create_members: true }
            },
            contractor_member: {
                name: "å·¥ç­æˆå“¡",
                role: "contractor_member",
                contractor_id: "contractor_A", // é è¨­å·¥ç­A
                permissions: { can_edit_own: true, can_view_own: true }
            },
            owner: {
                name: "æ¥­ä¸»",
                role: "owner",
                permissions: { can_edit_all: true, can_view_all: true }
            }
        };

        // å»ºç¯‰æ•¸æ“š
        const buildingData = {
            'A': {
                floors: [16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                units: ['A1', 'A2', 'A3', 'A4', 'A5', 'A6'],
                data: {}
            },
            'B': {
                floors: [14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                units: ['B1', 'B2', 'B3', 'B4'],
                data: {}
            },
            'C': {
                floors: [16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                units: ['C1', 'C2', 'C3', 'C4', 'C5'],
                data: {}
            }
        };

        const statusSymbols = {
            'completed': 'â—',
            'finished': 'â—‹',
            'ready': 'âœ“',
            'blocked': 'âœ—',
            'repair': 'â–²',
            'pending': 'â”€'
        };

        let currentBuilding = 'A';
        let currentUser = userProfiles.admin;
        let selectedContractor = null;

        // æ¬Šé™æª¢æŸ¥
        function hasPermission(building, floor, action) {
            if (currentUser.role === 'admin' || currentUser.role === 'owner') {
                return 'edit'; // ç®¡ç†å“¡å’Œæ¥­ä¸»å¯ä»¥ç·¨è¼¯æ‰€æœ‰
            }
            
            if (currentUser.role === 'contractor_leader' || currentUser.role === 'contractor_member') {
                if (!selectedContractor) return 'none';
                
                const contractor = siteData.contractors.find(c => c.id === selectedContractor);
                if (!contractor) return 'none';
                
                // æª¢æŸ¥å»ºç¯‰
                if (!contractor.assigned_areas.buildings.includes(building)) {
                    return 'none';
                }
                
                // æª¢æŸ¥æ¨“å±¤
                if (contractor.assigned_areas.floors !== 'all' && 
                    !contractor.assigned_areas.floors.includes(floor)) {
                    return 'none';
                }
                
                return 'edit';
            }
            
            return 'none';
        }

        // åˆ‡æ›è§’è‰²
        function switchRole() {
            const roleSelect = document.getElementById('roleSelect');
            currentUser = userProfiles[roleSelect.value];
            selectedContractor = null;
            updateUserInfo();
            updateUserActions();
            updateContractorSelector();
            updateGrid();
        }

        // åˆ‡æ›å·¥ç­
        function switchContractor() {
            const contractorSelect = document.getElementById('contractorSelect');
            selectedContractor = contractorSelect.value;
            updateContractorInfo();
            updateGrid();
        }

        // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯
        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            let info = `ç™»å…¥èº«ä»½ï¼š${currentUser.name}`;
            
            if (selectedContractor) {
                const contractor = siteData.contractors.find(c => c.id === selectedContractor);
                if (contractor) {
                    info += ` - ${contractor.name}`;
                    const buildings = contractor.assigned_areas.buildings.join('ã€');
                    const floors = contractor.assigned_areas.floors === 'all' ? 'å…¨éƒ¨æ¨“å±¤' : `${contractor.assigned_areas.floors.join(',')}æ¨“`;
                    info += ` | è² è²¬å€åŸŸï¼š${buildings}æ£Ÿ (${floors})`;
                }
            } else if (currentUser.role === 'owner') {
                info += ` | æ¬Šé™ï¼šæŸ¥çœ‹å’Œç·¨è¼¯æ‰€æœ‰è³‡æ–™`;
            }
            
            userInfo.textContent = info;
        }

        // æ›´æ–°ç”¨æˆ¶æ“ä½œ
        function updateUserActions() {
            const userActions = document.getElementById('userActions');
            userActions.innerHTML = '';
            
            if (currentUser.permissions.can_create_users) {
                userActions.innerHTML += '<button class="btn btn-primary" onclick="openCreateModal(\'contractor_leader\')">å‰µå»ºå·¥ç­ä¸»è¦è² è²¬äºº</button>';
                userActions.innerHTML += '<button class="btn btn-success" onclick="openCreateModal(\'owner\')">å‰µå»ºæ¥­ä¸»</button>';
            }
            
            if (currentUser.permissions.can_create_members) {
                userActions.innerHTML += '<button class="btn btn-secondary" onclick="openCreateModal(\'contractor_member\')">å‰µå»ºå·¥ç­æˆå“¡</button>';
            }
        }

        // æ›´æ–°å·¥ç­é¸æ“‡å™¨
        function updateContractorSelector() {
            const contractorSelector = document.getElementById('contractorSelector');
            const contractorSelect = document.getElementById('contractorSelect');
            
            if (currentUser.role === 'contractor_leader') {
                contractorSelector.style.display = 'block';
                
                // ç”Ÿæˆå·¥ç­é¸é …
                contractorSelect.innerHTML = '<option value="">è«‹é¸æ“‡å·¥ç­</option>';
                siteData.contractors.forEach(contractor => {
                    const option = document.createElement('option');
                    option.value = contractor.id;
                    option.textContent = contractor.name;
                    contractorSelect.appendChild(option);
                });
            } else {
                contractorSelector.style.display = 'none';
            }
        }

        // æ›´æ–°å·¥ç­ä¿¡æ¯
        function updateContractorInfo() {
            const contractorInfo = document.getElementById('contractorInfo');
            
            if (selectedContractor) {
                const contractor = siteData.contractors.find(c => c.id === selectedContractor);
                if (contractor) {
                    const buildings = contractor.assigned_areas.buildings.join('ã€');
                    const floors = contractor.assigned_areas.floors === 'all' ? 'å…¨éƒ¨æ¨“å±¤' : `${contractor.assigned_areas.floors.join(',')}æ¨“`;
                    contractorInfo.innerHTML = `è² è²¬å€åŸŸï¼š${buildings}æ£Ÿ (${floors})`;
                    contractorInfo.style.display = 'block';
                }
            } else {
                contractorInfo.style.display = 'none';
            }
        }

        // åˆ‡æ›å»ºç¯‰
        function switchBuilding(building) {
            currentBuilding = building;
            updateBuildingTabs();
            updateGrid();
        }

        // æ›´æ–°å»ºç¯‰æ¨™ç±¤
        function updateBuildingTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active', 'readonly');
            });
            
            const permission = hasPermission(currentBuilding, 1, 'view');
            const activeTab = document.querySelector(`.tab[onclick*="${currentBuilding}"]`);
            
            if (permission === 'edit') {
                activeTab.classList.add('active');
            } else if (permission === 'readonly') {
                activeTab.classList.add('readonly');
            }
        }

        // æ›´æ–°ç¶²æ ¼
        function updateGrid() {
            const building = buildingData[currentBuilding];
            const gridBody = document.getElementById('gridBody');
            const thead = document.querySelector('.construction-grid thead tr');
            
            thead.innerHTML = '<th>æ¨“å±¤/æˆ¶åˆ¥</th>';
            building.units.forEach(unit => {
                thead.innerHTML += `<th>${unit}</th>`;
            });
            
            gridBody.innerHTML = '';
            
            building.floors.forEach(floor => {
                const row = document.createElement('tr');
                
                const floorPermission = hasPermission(currentBuilding, floor, 'view');
                let floorClass = 'floor-label';
                if (floorPermission === 'none') {
                    floorClass += ' floor-restricted';
                }
                
                row.innerHTML = `<td class="${floorClass}">${floor}</td>`;
                
                building.units.forEach(unit => {
                    const key = `${floor}-${unit}`;
                    const unitData = building.data[key] || { status: 'pending' };
                    const symbol = statusSymbols[unitData.status];
                    
                    const permission = hasPermission(currentBuilding, floor, 'view');
                    
                    let cellClass = `status-${unitData.status}`;
                    let onclick = '';
                    
                    if (permission === 'edit') {
                        onclick = `onclick="showUnitInfo('${key}')"`;
                    } else if (permission === 'readonly') {
                        cellClass += ' readonly';
                        onclick = `onclick="showReadonlyInfo('${key}')"`;
                    } else {
                        cellClass += ' no-permission';
                    }
                    
                    row.innerHTML += `<td class="${cellClass}" ${onclick}>${symbol}</td>`;
                });
                
                gridBody.appendChild(row);
            });
        }

        // é¡¯ç¤ºå–®å…ƒè©³æƒ…
        function showUnitInfo(key) {
            alert(`å¯ç·¨è¼¯å–®å…ƒï¼š${key}`);
        }

        // é¡¯ç¤ºå”¯è®€ä¿¡æ¯
        function showReadonlyInfo(key) {
            alert(`å”¯è®€å–®å…ƒï¼š${key} (åƒ…å¯æŸ¥çœ‹)`);
        }

        // æ‰“é–‹å‰µå»ºç”¨æˆ¶Modal
        function openCreateModal(type) {
            document.getElementById('userType').value = type;
            updateUserForm();
            updateContractorOptions();
            document.getElementById('createUserModal').style.display = 'block';
        }

        // é—œé–‰Modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ›´æ–°ç”¨æˆ¶è¡¨å–®
        function updateUserForm() {
            const userType = document.getElementById('userType').value;
            const contractorFields = document.getElementById('contractorFields');
            const ownerFields = document.getElementById('ownerFields');
            
            if (userType === 'owner') {
                contractorFields.style.display = 'none';
                ownerFields.style.display = 'block';
            } else {
                contractorFields.style.display = 'block';
                ownerFields.style.display = 'none';
            }
        }

        // æ›´æ–°å·¥ç­é¸é …
        function updateContractorOptions() {
            const contractorGroupSelect = document.getElementById('contractorGroupSelect');
            contractorGroupSelect.innerHTML = '<option value="">è«‹é¸æ“‡å·¥ç­</option>';
            
            siteData.contractors.forEach(contractor => {
                const option = document.createElement('option');
                option.value = contractor.id;
                option.textContent = contractor.name;
                contractorGroupSelect.appendChild(option);
            });
        }

        // å‰µå»ºç”¨æˆ¶
        function createUser() {
            const userType = document.getElementById('userType').value;
            const userName = document.getElementById('userName').value;
            const userPhone = document.getElementById('userPhone').value;
            
            if (!userName || !userPhone) {
                alert('è«‹å¡«å¯«å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            if (userType !== 'owner') {
                const contractorId = document.getElementById('contractorGroupSelect').value;
                if (!contractorId) {
                    alert('è«‹é¸æ“‡å·¥ç­');
                    return;
                }
                
                const contractor = siteData.contractors.find(c => c.id === contractorId);
                alert(`å·²å‰µå»º${userType === 'contractor_leader' ? 'å·¥ç­ä¸»è¦è² è²¬äºº' : 'å·¥ç­æˆå“¡'}ï¼š${userName} (${userPhone})\nå·¥ç­ï¼š${contractor.name}`);
            } else {
                alert(`å·²å‰µå»ºæ¥­ä¸»ï¼š${userName} (${userPhone})\næ¬Šé™ï¼šæŸ¥çœ‹å’Œç·¨è¼¯æ‰€æœ‰è³‡æ–™`);
            }
            
            closeModal('createUserModal');
        }

        // åˆå§‹åŒ–æ•¸æ“š
        function initializeData() {
            Object.keys(buildingData).forEach(building => {
                const floors = buildingData[building].floors;
                const units = buildingData[building].units;
                
                floors.forEach(floor => {
                    units.forEach(unit => {
                        const statuses = ['completed', 'finished', 'ready', 'blocked', 'repair', 'pending'];
                        const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                        
                        buildingData[building].data[`${floor}-${unit}`] = {
                            status: randomStatus
                        };
                    });
                });
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            updateUserInfo();
            updateUserActions();
            updateContractorSelector();
            updateGrid();
        });
    </script>
</body>
</html>