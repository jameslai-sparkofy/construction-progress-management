<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∞°ÂåñÊ¨äÈôêÁ≥ªÁµ± - ÊñΩÂ∑•ÈÄ≤Â∫¶ÁÆ°ÁêÜ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #E0E0E0;
        }

        .header h1 {
            color: #333;
            font-size: 1.6em;
            margin-bottom: 20px;
        }

        .user-info {
            background: #E3F2FD;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9em;
            border-left: 4px solid #1976D2;
        }

        .contractor-selector {
            background: #F8F9FA;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #E0E0E0;
        }

        .contractor-selector h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1em;
        }

        .contractor-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
        }

        .contractor-info {
            margin-top: 10px;
            padding: 10px;
            background: #E8F5E8;
            border-radius: 6px;
            font-size: 0.85em;
            color: #2E7D32;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1976D2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565C0;
        }

        .btn-success {
            background: #388E3C;
            color: white;
        }

        .btn-success:hover {
            background: #2E7D32;
        }

        .btn-secondary {
            background: #757575;
            color: white;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .building-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            background: #E0E0E0;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
            color: #666;
        }

        .tab.active {
            background: #1976D2;
            color: white;
        }

        .tab.readonly {
            background: #FFF3E0;
            color: #E65100;
        }

        .tab:hover:not(.active):not(.readonly) {
            background: #BDBDBD;
        }

        .grid-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #E0E0E0;
            overflow-x: auto;
        }

        .construction-grid {
            min-width: 500px;
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9em;
        }

        .construction-grid th,
        .construction-grid td {
            border: 1px solid #E0E0E0;
            padding: 10px 8px;
            text-align: center;
            position: relative;
        }

        .construction-grid th {
            background: #F5F5F5;
            color: #333;
            font-weight: 600;
            font-size: 0.85em;
        }

        .construction-grid td {
            width: 70px;
            height: 45px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .construction-grid td:hover {
            background: #F0F8FF;
        }

        .construction-grid td.readonly {
            background: #FFF8E1;
            cursor: default;
        }

        .construction-grid td.readonly:hover {
            background: #FFF3C4;
        }

        .construction-grid td.no-permission {
            background: #FAFAFA;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .floor-label {
            background: #E0E0E0 !important;
            color: #333 !important;
            font-weight: 600;
            cursor: default !important;
        }

        .floor-restricted {
            background: #FFEBEE !important;
            color: #C62828 !important;
        }

        /* ÁãÄÊÖãÈ°èËâ≤ */
        .status-completed { color: #2E7D32; }
        .status-finished { color: #1976D2; }
        .status-ready { color: #F57C00; }
        .status-blocked { color: #D32F2F; }
        .status-repair { color: #7B1FA2; }
        .status-pending { color: #616161; }

        /* ModalÊ®£Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 25px;
            min-width: 400px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #E0E0E0;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .role-demo {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .role-demo label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
            font-weight: 500;
            color: #666;
        }

        .role-demo select {
            width: 100%;
            padding: 5px;
            font-size: 0.85em;
            border: 1px solid #E0E0E0;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .user-actions {
                flex-direction: column;
            }

            .building-tabs {
                flex-direction: column;
            }

            .tab {
                margin-bottom: 5px;
            }

            .role-demo {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä ÊñΩÂ∑•ÈÄ≤Â∫¶ÁÆ°ÁêÜÁ≥ªÁµ±</h1>
            
            <div class="user-info" id="userInfo">
                <!-- ÂãïÊÖãÈ°ØÁ§∫Áî®Êà∂‰ø°ÊÅØ -->
            </div>
            
            <!-- Â∑•Áè≠ÈÅ∏ÊìáÂô® -->
            <div class="contractor-selector" id="contractorSelector" style="display: none;">
                <h3>ÈÅ∏ÊìáÂ∑•Áè≠</h3>
                <select id="contractorSelect" onchange="switchContractor()">
                    <option value="">Ë´ãÈÅ∏ÊìáÂ∑•Áè≠</option>
                    <!-- ÂãïÊÖãÁîüÊàêÂ∑•Áè≠ÈÅ∏È†Ö -->
                </select>
                <div class="contractor-info" id="contractorInfo" style="display: none;">
                    <!-- È°ØÁ§∫ÈÅ∏‰∏≠Â∑•Áè≠ÁöÑË≤†Ë≤¨ÂçÄÂüü -->
                </div>
            </div>
            
            <div class="user-actions" id="userActions">
                <!-- ÂãïÊÖãÈ°ØÁ§∫Áî®Êà∂ÂèØÁî®Êìç‰Ωú -->
            </div>
        </div>

        <!-- Âª∫ÁØâÈÅ∏ÊìáÂíåÁ∂≤Ê†º -->
        <div class="grid-container">
            <div class="building-tabs" id="buildingTabs">
                <button class="tab active" onclick="switchBuilding('A')">AÊ£ü</button>
                <button class="tab" onclick="switchBuilding('B')">BÊ£ü</button>
                <button class="tab" onclick="switchBuilding('C')">CÊ£ü</button>
            </div>

            <table class="construction-grid" id="constructionGrid">
                <thead>
                    <tr>
                        <th>Ê®ìÂ±§/Êà∂Âà•</th>
                        <th>A1</th>
                        <th>A2</th>
                        <th>A3</th>
                        <th>A4</th>
                        <th>A5</th>
                        <th>A6</th>
                    </tr>
                </thead>
                <tbody id="gridBody">
                    <!-- ÂãïÊÖãÁîüÊàêÂÖßÂÆπ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ÂâµÂª∫Áî®Êà∂Modal -->
    <div class="modal" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÂâµÂª∫Áî®Êà∂</h3>
                <button class="close" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Áî®Êà∂È°ûÂûãÔºö</label>
                <select id="userType" onchange="updateUserForm()">
                    <option value="contractor_leader">Â∑•Áè≠‰∏ªË¶ÅË≤†Ë≤¨‰∫∫</option>
                    <option value="contractor_member">Â∑•Áè≠ÊàêÂì°</option>
                    <option value="owner">Ê•≠‰∏ª</option>
                </select>
            </div>
            <div class="form-group">
                <label>ÂßìÂêçÔºö</label>
                <input type="text" id="userName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç">
            </div>
            <div class="form-group">
                <label>ÈõªË©±Ôºö</label>
                <input type="tel" id="userPhone" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º">
            </div>
            <div id="contractorFields">
                <div class="form-group">
                    <label>Â∑•Áè≠ÈÅ∏ÊìáÔºö</label>
                    <select id="contractorGroupSelect">
                        <option value="">Ë´ãÈÅ∏ÊìáÂ∑•Áè≠</option>
                        <!-- ÂãïÊÖãÁîüÊàêÂ∑•Áè≠ÈÅ∏È†Ö -->
                    </select>
                    <div class="help-text">ÈÅ∏ÊìáË©≤Áî®Êà∂ÊâÄÂ±¨ÁöÑÂ∑•Áè≠</div>
                </div>
            </div>
            <div id="ownerFields" style="display: none;">
                <div class="form-group">
                    <label>Ê•≠‰∏ªÊ¨äÈôêÔºö</label>
                    <div class="help-text">Ê•≠‰∏ªÂèØ‰ª•Êü•ÁúãÂíåÁ∑®ËºØÊï¥ÂÄãÊ°àÂ†¥ÁöÑÊâÄÊúâË≥áÊñô</div>
                </div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="createUser()">ÂâµÂª∫</button>
            </div>
        </div>
    </div>

    <!-- ËßíËâ≤ÊºîÁ§∫ÂàáÊèõÂô® -->
    <div class="role-demo">
        <label>ÊºîÁ§∫ËßíËâ≤ÂàáÊèõÔºö</label>
        <select id="roleSelect" onchange="switchRole()">
            <option value="admin">ÁÆ°ÁêÜÂì°</option>
            <option value="contractor_leader">Â∑•Áè≠‰∏ªË¶ÅË≤†Ë≤¨‰∫∫</option>
            <option value="contractor_member">Â∑•Áè≠ÊàêÂì°</option>
            <option value="owner">Ê•≠‰∏ª</option>
        </select>
    </div>

    <script>
        // Ê°àÂ†¥Êï∏ÊìöÔºàÂåÖÂê´Â∑•Áè≠‰ø°ÊÅØÔºâ
        const siteData = {
            site_id: "site123",
            name: "ÂãùËàà-ËààÂÆâË•ø-2023",
            contractors: [
                {
                    id: "contractor_A",
                    name: "ABCÂ∑•Á®ãË°å",
                    leader_phone: "17600000001",
                    members: ["17600000002", "17600000003"],
                    assigned_areas: {
                        buildings: ["A"],
                        floors: "all"
                    }
                },
                {
                    id: "contractor_B", 
                    name: "XYZÂª∫Ë®≠",
                    leader_phone: "17600000004",
                    members: ["17600000005"],
                    assigned_areas: {
                        buildings: ["B"],
                        floors: "all"
                    }
                },
                {
                    id: "contractor_C",
                    name: "DEFÁáüÈÄ†",
                    leader_phone: "17600000006",
                    members: ["17600000007"],
                    assigned_areas: {
                        buildings: ["C"],
                        floors: [1,2,3,4,5]
                    }
                },
                {
                    id: "contractor_D",
                    name: "GHIÂ∑•Á®ã",
                    leader_phone: "17600000008",
                    members: ["17600000009"],
                    assigned_areas: {
                        buildings: ["C"],
                        floors: [6,7,8,9,10,11,12,13,14,15,16]
                    }
                }
            ],
            owners: [
                {
                    id: "owner_001",
                    name: "Ê•≠‰∏ªA",
                    phone: "17700000001"
                },
                {
                    id: "owner_002", 
                    name: "Ê•≠‰∏ªB",
                    phone: "17700000002"
                }
            ]
        };

        // Áî®Êà∂Ê¨äÈôêÈÖçÁΩÆ
        const userProfiles = {
            admin: {
                name: "Á≥ªÁµ±ÁÆ°ÁêÜÂì°",
                role: "admin",
                permissions: { can_edit_all: true, can_view_all: true, can_create_users: true }
            },
            contractor_leader: {
                name: "Â∑•Áè≠‰∏ªË¶ÅË≤†Ë≤¨‰∫∫",
                role: "contractor_leader",
                contractor_id: null, // ÈúÄË¶ÅÈÅ∏ÊìáÂ∑•Áè≠
                permissions: { can_edit_own: true, can_view_own: true, can_create_members: true }
            },
            contractor_member: {
                name: "Â∑•Áè≠ÊàêÂì°",
                role: "contractor_member",
                contractor_id: "contractor_A", // È†êË®≠Â∑•Áè≠A
                permissions: { can_edit_own: true, can_view_own: true }
            },
            owner: {
                name: "Ê•≠‰∏ª",
                role: "owner",
                permissions: { can_edit_all: true, can_view_all: true }
            }
        };

        // Âª∫ÁØâÊï∏Êìö
        const buildingData = {
            'A': {
                floors: [16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                units: ['A1', 'A2', 'A3', 'A4', 'A5', 'A6'],
                data: {}
            },
            'B': {
                floors: [14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                units: ['B1', 'B2', 'B3', 'B4'],
                data: {}
            },
            'C': {
                floors: [16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                units: ['C1', 'C2', 'C3', 'C4', 'C5'],
                data: {}
            }
        };

        const statusSymbols = {
            'completed': '‚óè',
            'finished': '‚óã',
            'ready': '‚úì',
            'blocked': '‚úó',
            'repair': '‚ñ≤',
            'pending': '‚îÄ'
        };

        let currentBuilding = 'A';
        let currentUser = userProfiles.admin;
        let selectedContractor = null;

        // Ê¨äÈôêÊ™¢Êü•
        function hasPermission(building, floor, action) {
            if (currentUser.role === 'admin' || currentUser.role === 'owner') {
                return 'edit'; // ÁÆ°ÁêÜÂì°ÂíåÊ•≠‰∏ªÂèØ‰ª•Á∑®ËºØÊâÄÊúâ
            }
            
            if (currentUser.role === 'contractor_leader' || currentUser.role === 'contractor_member') {
                if (!selectedContractor) return 'none';
                
                const contractor = siteData.contractors.find(c => c.id === selectedContractor);
                if (!contractor) return 'none';
                
                // Ê™¢Êü•Âª∫ÁØâ
                if (!contractor.assigned_areas.buildings.includes(building)) {
                    return 'none';
                }
                
                // Ê™¢Êü•Ê®ìÂ±§
                if (contractor.assigned_areas.floors !== 'all' && 
                    !contractor.assigned_areas.floors.includes(floor)) {
                    return 'none';
                }
                
                return 'edit';
            }
            
            return 'none';
        }

        // ÂàáÊèõËßíËâ≤
        function switchRole() {
            const roleSelect = document.getElementById('roleSelect');
            currentUser = userProfiles[roleSelect.value];
            selectedContractor = null;
            updateUserInfo();
            updateUserActions();
            updateContractorSelector();
            updateGrid();
        }

        // ÂàáÊèõÂ∑•Áè≠
        function switchContractor() {
            const contractorSelect = document.getElementById('contractorSelect');
            selectedContractor = contractorSelect.value;
            updateContractorInfo();
            updateGrid();
        }

        // Êõ¥Êñ∞Áî®Êà∂‰ø°ÊÅØ
        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            let info = `ÁôªÂÖ•Ë∫´‰ªΩÔºö${currentUser.name}`;
            
            if (selectedContractor) {
                const contractor = siteData.contractors.find(c => c.id === selectedContractor);
                if (contractor) {
                    info += ` - ${contractor.name}`;
                    const buildings = contractor.assigned_areas.buildings.join('„ÄÅ');
                    const floors = contractor.assigned_areas.floors === 'all' ? 'ÂÖ®ÈÉ®Ê®ìÂ±§' : `${contractor.assigned_areas.floors.join(',')}Ê®ì`;
                    info += ` | Ë≤†Ë≤¨ÂçÄÂüüÔºö${buildings}Ê£ü (${floors})`;
                }
            } else if (currentUser.role === 'owner') {
                info += ` | Ê¨äÈôêÔºöÊü•ÁúãÂíåÁ∑®ËºØÊâÄÊúâË≥áÊñô`;
            }
            
            userInfo.textContent = info;
        }

        // Êõ¥Êñ∞Áî®Êà∂Êìç‰Ωú
        function updateUserActions() {
            const userActions = document.getElementById('userActions');
            userActions.innerHTML = '';
            
            if (currentUser.permissions.can_create_users) {
                userActions.innerHTML += '<button class="btn btn-primary" onclick="openCreateModal(\'contractor_leader\')">ÂâµÂª∫Â∑•Áè≠‰∏ªË¶ÅË≤†Ë≤¨‰∫∫</button>';
                userActions.innerHTML += '<button class="btn btn-success" onclick="openCreateModal(\'owner\')">ÂâµÂª∫Ê•≠‰∏ª</button>';
            }
            
            if (currentUser.permissions.can_create_members) {
                userActions.innerHTML += '<button class="btn btn-secondary" onclick="openCreateModal(\'contractor_member\')">ÂâµÂª∫Â∑•Áè≠ÊàêÂì°</button>';
            }
        }

        // Êõ¥Êñ∞Â∑•Áè≠ÈÅ∏ÊìáÂô®
        function updateContractorSelector() {
            const contractorSelector = document.getElementById('contractorSelector');
            const contractorSelect = document.getElementById('contractorSelect');
            
            if (currentUser.role === 'contractor_leader') {
                contractorSelector.style.display = 'block';
                
                // ÁîüÊàêÂ∑•Áè≠ÈÅ∏È†Ö
                contractorSelect.innerHTML = '<option value="">Ë´ãÈÅ∏ÊìáÂ∑•Áè≠</option>';
                siteData.contractors.forEach(contractor => {
                    const option = document.createElement('option');
                    option.value = contractor.id;
                    option.textContent = contractor.name;
                    contractorSelect.appendChild(option);
                });
            } else {
                contractorSelector.style.display = 'none';
            }
        }

        // Êõ¥Êñ∞Â∑•Áè≠‰ø°ÊÅØ
        function updateContractorInfo() {
            const contractorInfo = document.getElementById('contractorInfo');
            
            if (selectedContractor) {
                const contractor = siteData.contractors.find(c => c.id === selectedContractor);
                if (contractor) {
                    const buildings = contractor.assigned_areas.buildings.join('„ÄÅ');
                    const floors = contractor.assigned_areas.floors === 'all' ? 'ÂÖ®ÈÉ®Ê®ìÂ±§' : `${contractor.assigned_areas.floors.join(',')}Ê®ì`;
                    contractorInfo.innerHTML = `Ë≤†Ë≤¨ÂçÄÂüüÔºö${buildings}Ê£ü (${floors})`;
                    contractorInfo.style.display = 'block';
                }
            } else {
                contractorInfo.style.display = 'none';
            }
        }

        // ÂàáÊèõÂª∫ÁØâ
        function switchBuilding(building) {
            currentBuilding = building;
            updateBuildingTabs();
            updateGrid();
        }

        // Êõ¥Êñ∞Âª∫ÁØâÊ®ôÁ±§
        function updateBuildingTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active', 'readonly');
            });
            
            const permission = hasPermission(currentBuilding, 1, 'view');
            const activeTab = document.querySelector(`.tab[onclick*="${currentBuilding}"]`);
            
            if (permission === 'edit') {
                activeTab.classList.add('active');
            } else if (permission === 'readonly') {
                activeTab.classList.add('readonly');
            }
        }

        // Êõ¥Êñ∞Á∂≤Ê†º
        function updateGrid() {
            const building = buildingData[currentBuilding];
            const gridBody = document.getElementById('gridBody');
            const thead = document.querySelector('.construction-grid thead tr');
            
            thead.innerHTML = '<th>Ê®ìÂ±§/Êà∂Âà•</th>';
            building.units.forEach(unit => {
                thead.innerHTML += `<th>${unit}</th>`;
            });
            
            gridBody.innerHTML = '';
            
            building.floors.forEach(floor => {
                const row = document.createElement('tr');
                
                const floorPermission = hasPermission(currentBuilding, floor, 'view');
                let floorClass = 'floor-label';
                if (floorPermission === 'none') {
                    floorClass += ' floor-restricted';
                }
                
                row.innerHTML = `<td class="${floorClass}">${floor}</td>`;
                
                building.units.forEach(unit => {
                    const key = `${floor}-${unit}`;
                    const unitData = building.data[key] || { status: 'pending' };
                    const symbol = statusSymbols[unitData.status];
                    
                    const permission = hasPermission(currentBuilding, floor, 'view');
                    
                    let cellClass = `status-${unitData.status}`;
                    let onclick = '';
                    
                    if (permission === 'edit') {
                        onclick = `onclick="showUnitInfo('${key}')"`;
                    } else if (permission === 'readonly') {
                        cellClass += ' readonly';
                        onclick = `onclick="showReadonlyInfo('${key}')"`;
                    } else {
                        cellClass += ' no-permission';
                    }
                    
                    row.innerHTML += `<td class="${cellClass}" ${onclick}>${symbol}</td>`;
                });
                
                gridBody.appendChild(row);
            });
        }

        // È°ØÁ§∫ÂñÆÂÖÉË©≥ÊÉÖ
        function showUnitInfo(key) {
            alert(`ÂèØÁ∑®ËºØÂñÆÂÖÉÔºö${key}`);
        }

        // È°ØÁ§∫ÂîØËÆÄ‰ø°ÊÅØ
        function showReadonlyInfo(key) {
            alert(`ÂîØËÆÄÂñÆÂÖÉÔºö${key} (ÂÉÖÂèØÊü•Áúã)`);
        }

        // ÊâìÈñãÂâµÂª∫Áî®Êà∂Modal
        function openCreateModal(type) {
            document.getElementById('userType').value = type;
            updateUserForm();
            updateContractorOptions();
            document.getElementById('createUserModal').style.display = 'block';
        }

        // ÈóúÈñâModal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Êõ¥Êñ∞Áî®Êà∂Ë°®ÂñÆ
        function updateUserForm() {
            const userType = document.getElementById('userType').value;
            const contractorFields = document.getElementById('contractorFields');
            const ownerFields = document.getElementById('ownerFields');
            
            if (userType === 'owner') {
                contractorFields.style.display = 'none';
                ownerFields.style.display = 'block';
            } else {
                contractorFields.style.display = 'block';
                ownerFields.style.display = 'none';
            }
        }

        // Êõ¥Êñ∞Â∑•Áè≠ÈÅ∏È†Ö
        function updateContractorOptions() {
            const contractorGroupSelect = document.getElementById('contractorGroupSelect');
            contractorGroupSelect.innerHTML = '<option value="">Ë´ãÈÅ∏ÊìáÂ∑•Áè≠</option>';
            
            siteData.contractors.forEach(contractor => {
                const option = document.createElement('option');
                option.value = contractor.id;
                option.textContent = contractor.name;
                contractorGroupSelect.appendChild(option);
            });
        }

        // ÂâµÂª∫Áî®Êà∂
        function createUser() {
            const userType = document.getElementById('userType').value;
            const userName = document.getElementById('userName').value;
            const userPhone = document.getElementById('userPhone').value;
            
            if (!userName || !userPhone) {
                alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥‰ø°ÊÅØ');
                return;
            }
            
            if (userType !== 'owner') {
                const contractorId = document.getElementById('contractorGroupSelect').value;
                if (!contractorId) {
                    alert('Ë´ãÈÅ∏ÊìáÂ∑•Áè≠');
                    return;
                }
                
                const contractor = siteData.contractors.find(c => c.id === contractorId);
                alert(`Â∑≤ÂâµÂª∫${userType === 'contractor_leader' ? 'Â∑•Áè≠‰∏ªË¶ÅË≤†Ë≤¨‰∫∫' : 'Â∑•Áè≠ÊàêÂì°'}Ôºö${userName} (${userPhone})\nÂ∑•Áè≠Ôºö${contractor.name}`);
            } else {
                alert(`Â∑≤ÂâµÂª∫Ê•≠‰∏ªÔºö${userName} (${userPhone})\nÊ¨äÈôêÔºöÊü•ÁúãÂíåÁ∑®ËºØÊâÄÊúâË≥áÊñô`);
            }
            
            closeModal('createUserModal');
        }

        // ÂàùÂßãÂåñÊï∏Êìö
        function initializeData() {
            Object.keys(buildingData).forEach(building => {
                const floors = buildingData[building].floors;
                const units = buildingData[building].units;
                
                floors.forEach(floor => {
                    units.forEach(unit => {
                        const statuses = ['completed', 'finished', 'ready', 'blocked', 'repair', 'pending'];
                        const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                        
                        buildingData[building].data[`${floor}-${unit}`] = {
                            status: randomStatus
                        };
                    });
                });
            });
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            updateUserInfo();
            updateUserActions();
            updateContractorSelector();
            updateGrid();
        });
    </script>
</body>
</html>