<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº·äº«é”€å®¢APIåœ¨çº¿æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .nav {
            background: rgba(248, 249, 250, 0.8);
            padding: 20px;
            border-bottom: 1px solid rgba(222, 226, 230, 0.5);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav button {
            background: linear-gradient(135deg, #007cba, #005a87);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .nav button:hover {
            background: linear-gradient(135deg, #005a87, #004065);
            transform: translateY(-2px);
        }
        
        .nav button.active {
            background: linear-gradient(135deg, #28a745, #20a139);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .box {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(222, 226, 230, 0.5);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }
        
        .box h3, .box h4 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .api-endpoint {
            background: linear-gradient(135deg, #e7f3ff, #b8daff);
            border: 2px solid #007cba;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #856404;
        }
        
        .result {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            color: #155724;
        }
        
        .error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
            color: #721c24;
        }
        
        .warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #ffc107;
            color: #856404;
        }
        
        .log {
            background: #1a202c;
            color: #68d391;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 250px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007cba, #28a745);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007cba;
        }
        
        button {
            background: linear-gradient(135deg, #007cba, #005a87);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        button:hover {
            background: linear-gradient(135deg, #005a87, #004065);
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .nav {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ çº·äº«é”€å®¢APIåœ¨çº¿æµ‹è¯•å·¥å…·</h1>
            <p>åŸºäºçœŸå®å­—æ®µæ˜ å°„ Â· å®Œæ•´APIéªŒè¯ Â· å³æ—¶æµ‹è¯•ç»“æœ</p>
        </div>
        
        <div class="nav">
            <button onclick="showSection('overview')" class="active">ğŸ“‹ æ¦‚è¿°</button>
            <button onclick="showSection('test-tool')">ğŸ§ª APIæµ‹è¯•</button>
            <button onclick="showSection('docs')">ğŸ“š æ–‡æ¡£</button>
            <button onclick="showSection('data-list')" id="dataListNavBtn" style="display: none;">ğŸ“‹ æ•°æ®æ¸…å•</button>
        </div>
        
        <div class="content">
            <!-- æ¦‚è¿°éƒ¨åˆ† -->
            <div id="overview" class="section active">
                <div class="box">
                    <h3>ğŸ¯ å·¥å…·æ¦‚è¿°</h3>
                    <p>è¿™ä¸ªåœ¨çº¿æµ‹è¯•å·¥å…·åŸºäºæ‚¨çš„Excelå­—æ®µæ˜ å°„æ–‡æ¡£å’Œçº·äº«é”€å®¢å®˜æ–¹APIå¼€å‘ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•APIè°ƒç”¨ã€‚</p>
                    
                    <h4>ğŸŒŸ ä¸»è¦åŠŸèƒ½</h4>
                    <ul>
                        <li><strong>Tokenç®¡ç†</strong> - è‡ªåŠ¨è·å–å’Œç®¡ç†ä¼ä¸šè®¿é—®ä»¤ç‰Œ</li>
                        <li><strong>ç”¨æˆ·éªŒè¯</strong> - é€šè¿‡æ‰‹æœºå·è·å–ç”¨æˆ·ä¿¡æ¯</li>
                        <li><strong>æ•°æ®æŸ¥è¯¢</strong> - æŸ¥è¯¢ç»´ä¿®å•æ•°æ®ï¼Œæ”¯æŒå¤šç§ç­›é€‰æ¡ä»¶</li>
                        <li><strong>å®æ—¶æ—¥å¿—</strong> - æ˜¾ç¤ºè¯¦ç»†çš„APIè°ƒç”¨è¿‡ç¨‹å’Œå“åº”</li>
                        <li><strong>æ•°æ®å¯¼å‡º</strong> - å°†æŸ¥è¯¢ç»“æœå¯¼å‡ºä¸ºJSONæ–‡ä»¶</li>
                    </ul>
                </div>
                
                <div class="box">
                    <h3>âš™ï¸ æ‚¨çš„é…ç½®ä¿¡æ¯</h3>
                    <div class="api-endpoint">
                        <strong>åº”ç”¨é…ç½®ï¼š</strong><br>
                        <span class="highlight">AppID:</span> FSAID_1320691<br>
                        <span class="highlight">AppSecret:</span> ec63ff237c5c4a759be36d3a8fb7a3b4<br>
                        <span class="highlight">æ°¸ä¹…æˆæƒç :</span> 899433A4A04A3B8CB1CC2183DA4B5B48<br>
                        <span class="highlight">æµ‹è¯•æ‰‹æœº:</span> 17675662629<br>
                        <span class="highlight">ç»´ä¿®å•å¯¹è±¡:</span> on_site_signature__c
                    </div>
                </div>
                
                <div class="box">
                    <h3>ğŸš¨ é‡è¦æé†’</h3>
                    <div class="warning">
                        <strong>CORSè·¨åŸŸé—®é¢˜ï¼š</strong><br>
                        æµè§ˆå™¨å¯èƒ½ä¼šé˜»æ­¢è·¨åŸŸè¯·æ±‚ã€‚å¦‚æœé‡åˆ°CORSé”™è¯¯ï¼Œè¯·ï¼š
                        <ul>
                            <li>ä½¿ç”¨Chromeå¼€å‘è€…æ¨¡å¼å¯åŠ¨ï¼ˆæ·»åŠ  --disable-web-security å‚æ•°ï¼‰</li>
                            <li>å®‰è£…CORSæµè§ˆå™¨æ‰©å±•</li>
                            <li>å°†ä»£ç å¤åˆ¶åˆ°æœ¬åœ°æœåŠ¡å™¨è¿è¡Œ</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- APIæµ‹è¯•å·¥å…· -->
            <div id="test-tool" class="section">
                <div class="box">
                    <h3>ğŸ§ª APIåŠŸèƒ½æµ‹è¯•</h3>
                    
                    <div class="box">
                        <h4>æ­¥éª¤ 1: è·å–ä¼ä¸šè®¿é—®ä»¤ç‰Œ</h4>
                        <button onclick="testGetToken()" id="tokenBtn">ğŸ”‘ è·å–Token</button>
                        <div class="progress-bar">
                            <div class="progress-fill" id="tokenProgress" style="width: 0%"></div>
                        </div>
                        <div id="tokenResult"></div>
                    </div>
                    
                    <div class="box">
                        <h4>æ­¥éª¤ 2: è·å–ç”¨æˆ·ä¿¡æ¯</h4>
                        <input type="text" id="mobileInput" placeholder="è¾“å…¥æ‰‹æœºå·" value="17675662629">
                        <button onclick="testGetUser()" id="userBtn" disabled>ğŸ‘¤ è·å–ç”¨æˆ·</button>
                        <div class="progress-bar">
                            <div class="progress-fill" id="userProgress" style="width: 0%"></div>
                        </div>
                        <div id="userResult"></div>
                    </div>
                    
                    <div class="box">
                        <h4>æ­¥éª¤ 3: æŸ¥è¯¢ç»´ä¿®å•æ•°æ®</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="limitInput" placeholder="æŸ¥è¯¢æ•°é‡" value="10" min="1" max="100">
                            <input type="number" id="offsetInput" placeholder="åç§»é‡" value="0" min="0">
                            <select id="statusInput">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="æ­£å¸¸">æ­£å¸¸</option>
                                <option value="æœªç”Ÿæ•ˆ">æœªç”Ÿæ•ˆ</option>
                                <option value="å¯©æ ¸ä¸­">å¯©æ ¸ä¸­</option>
                                <option value="è®Šæ›´ä¸­">è®Šæ›´ä¸­</option>
                                <option value="ä½œå»¢">ä½œå»¢</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="testQueryWithoutSearchFields()" id="queryNoFieldsBtn" disabled>ğŸš€ ä¸é™å­—æ®µæŸ¥è¯¢</button>
                            <button onclick="testQueryBasic()" id="queryBasicBtn" disabled>ğŸ“‹ åŸºç¡€æŸ¥è¯¢</button>
                            <button onclick="debugData()" id="debugBtn" style="background: #dc3545;">ğŸ”§ è°ƒè¯•æ•°æ®</button>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button onclick="testExport()" id="exportBtn" disabled>ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                            <button onclick="showDataList()" id="listBtn" disabled>ğŸ“Š æ•°æ®æ¸…å•</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="queryProgress" style="width: 0%"></div>
                        </div>
                        <div id="queryResult"></div>
                    </div>
                </div>
                
                <div class="box">
                    <h3>ğŸ“Š å®æ—¶æ—¥å¿—</h3>
                    <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
                    <div id="testLog" class="log">ç­‰å¾…APIæµ‹è¯•æ“ä½œ...\n</div>
                </div>
            </div>
            
            <!-- æ•°æ®æ¸…å• -->
            <div id="data-list" class="section">
                <div class="box">
                    <h3>ğŸ“‹ ç»´ä¿®å•æ•°æ®æ¸…å•</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <span id="listSummary">æš‚æ— æ•°æ®</span>
                        </div>
                        <div>
                            <button onclick="batchEdit()" style="background: #ffc107; color: #212529;">ğŸ“ æ‰¹é‡ç¼–è¾‘</button>
                            <button onclick="testExport()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                            <button onclick="clearDataList()">ğŸ—‘ï¸ æ¸…ç©ºæ¸…å•</button>
                        </div>
                    </div>
                    
                    <!-- æ•°æ®è¡¨æ ¼ -->
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table id="dataTable" style="width: 100%; border-collapse: collapse; font-size: 12px; background: white; border-radius: 8px; overflow: hidden;">
                            <thead id="tableHeader" style="background: #007cba; color: white;">
                                <tr>
                                    <th style="padding: 12px 8px;">åºå·</th>
                                    <th style="padding: 12px 8px;">ç»´ä¿®å•ç¼–å·</th>
                                    <th style="padding: 12px 8px;">çŠ¶æ€</th>
                                    <th style="padding: 12px 8px;">åˆ›å»ºæ—¶é—´</th>
                                    <th style="padding: 12px 8px;">è´Ÿè´£äºº</th>
                                    <th style="padding: 12px 8px;">å•†æœº</th>
                                    <th style="padding: 12px 8px;">æ¡ˆåœº</th>
                                    <th style="padding: 12px 8px;">é‡‘é¢</th>
                                    <th style="padding: 12px 8px; width: 120px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">æš‚æ— æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ç¼–è¾‘å¼¹çª— -->
                <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <h3>âœï¸ ç¼–è¾‘ç»´ä¿®å•</h3>
                        <div id="editForm">
                            <!-- ç¼–è¾‘è¡¨å•å°†ç”±JavaScriptç”Ÿæˆ -->
                        </div>
                        <div style="margin-top: 20px; text-align: right;">
                            <button onclick="closeEditModal()" style="background: #6c757d; margin-right: 10px;">å–æ¶ˆ</button>
                            <button onclick="saveChanges()" style="background: #28a745;">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                        </div>
                        <div id="editResult" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- æ–‡æ¡£éƒ¨åˆ† -->
            <div id="docs" class="section">
                <div class="box">
                    <h3>ğŸ“š APIç«¯ç‚¹æ–‡æ¡£</h3>
                    
                    <h4>1. è·å–ä¼ä¸šè®¿é—®ä»¤ç‰Œ</h4>
                    <div class="api-endpoint">
                        <strong>URL:</strong> <code>https://open.fxiaoke.com/cgi/corpAccessToken/get/V2</code><br>
                        <strong>æ–¹æ³•:</strong> POST<br>
                        <strong>è¯´æ˜:</strong> è·å–ä¼ä¸šçº§è®¿é—®ä»¤ç‰Œï¼Œæœ‰æ•ˆæœŸ7200ç§’
                    </div>
                    
                    <h4>2. é€šè¿‡æ‰‹æœºå·è·å–ç”¨æˆ·ä¿¡æ¯</h4>
                    <div class="api-endpoint">
                        <strong>URL:</strong> <code>https://open.fxiaoke.com/cgi/user/getByMobile</code><br>
                        <strong>æ–¹æ³•:</strong> POST<br>
                        <strong>è¯´æ˜:</strong> è·å–ç”¨æˆ·çš„openUserIdï¼Œç”¨äºAPIè°ƒç”¨èº«ä»½è®¤è¯
                    </div>
                    
                    <h4>3. æŸ¥è¯¢è‡ªå®šä¹‰å¯¹è±¡æ•°æ® â­</h4>
                    <div class="api-endpoint">
                        <strong>URL:</strong> <code>https://open.fxiaoke.com/cgi/crm/custom/v2/data/query</code><br>
                        <strong>æ–¹æ³•:</strong> POST<br>
                        <strong>å¯¹è±¡:</strong> on_site_signature__c (ç»´ä¿®å•)<br>
                        <strong>é‡è¦:</strong> è‡ªå®šä¹‰å¯¹è±¡å¿…é¡»ä½¿ç”¨ custom ç«¯ç‚¹ï¼
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let testToken = null;
        let testCorpId = null;
        let testUserId = null;
        let testData = [];
        let currentEditIndex = -1;
        let originalData = {};
        
        const CONFIG = {
            appId: "FSAID_1320691",
            appSecret: "ec63ff237c5c4a759be36d3a8fb7a3b4",
            permanentCode: "899433A4A04A3B8CB1CC2183DA4B5B48",
            baseUrl: "https://open.fxiaoke.com"
        };

        // æ˜¾ç¤ºä¸åŒéƒ¨åˆ†çš„å‡½æ•°
        function showSection(sectionId) {
            console.log('åˆ‡æ¢åˆ°é¡µé¢:', sectionId);
            
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡éƒ¨åˆ†
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                log(`åˆ‡æ¢åˆ°é¡µé¢: ${sectionId}`);
            } else {
                console.error('æ‰¾ä¸åˆ°é¡µé¢:', sectionId);
            }
            
            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLog');
            if (logDiv) {
                logDiv.textContent += `[${timestamp}] ${message}\n`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            console.log(message);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = '') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="result ${type}">${message}</div>`;
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(progressId, percent) {
            const progressBar = document.getElementById(progressId);
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
        }

        // æµ‹è¯•è·å–Token
        async function testGetToken() {
            log('å¼€å§‹è·å–ä¼ä¸šè®¿é—®ä»¤ç‰Œ...');
            updateProgress('tokenProgress', 20);
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/cgi/corpAccessToken/get/V2`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        appId: CONFIG.appId,
                        appSecret: CONFIG.appSecret,
                        permanentCode: CONFIG.permanentCode
                    }),
                    mode: 'cors'
                });
                
                updateProgress('tokenProgress', 60);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`Tokenå“åº”: ${JSON.stringify(result, null, 2)}`);
                
                if (result.errorCode === 0) {
                    testToken = result.corpAccessToken;
                    testCorpId = result.corpId;
                    updateProgress('tokenProgress', 100);
                    
                    showResult('tokenResult', 
                        `âœ… Tokenè·å–æˆåŠŸ!<br><strong>ä¼ä¸šID:</strong> ${testCorpId}<br><strong>Token:</strong> ${testToken.substring(0, 20)}...`, 'success');
                    
                    // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                    document.getElementById('userBtn').disabled = false;
                    log('Tokenè·å–æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œç”¨æˆ·éªŒè¯');
                } else {
                    throw new Error(`APIé”™è¯¯: ${result.errorMessage} (${result.errorCode})`);
                }
            } catch (error) {
                updateProgress('tokenProgress', 0);
                log(`Tokenè·å–å¤±è´¥: ${error.message}`);
                showResult('tokenResult', `âŒ Tokenè·å–å¤±è´¥: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    showResult('tokenResult', 
                        `âŒ CORSè·¨åŸŸé”™è¯¯<br>è¯·å°è¯•ï¼š<br>1. ä½¿ç”¨Chromeå¼€å‘è€…æ¨¡å¼<br>2. å®‰è£…CORSæ‰©å±•<br>3. åœ¨æœåŠ¡å™¨ç¯å¢ƒè¿è¡Œ`, 'error');
                }
            }
        }

        // æµ‹è¯•è·å–ç”¨æˆ·
        async function testGetUser() {
            const mobile = document.getElementById('mobileInput').value.trim();
            if (!mobile) {
                log('è¯·è¾“å…¥æ‰‹æœºå·');
                return;
            }
            
            if (!testToken) {
                log('è¯·å…ˆè·å–Token');
                return;
            }
            
            log(`è·å–ç”¨æˆ·ä¿¡æ¯: ${mobile}`);
            updateProgress('userProgress', 30);
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/cgi/user/getByMobile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        corpId: testCorpId,
                        corpAccessToken: testToken,
                        mobile: mobile
                    }),
                    mode: 'cors'
                });
                
                updateProgress('userProgress', 70);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`ç”¨æˆ·å“åº”: ${JSON.stringify(result, null, 2)}`);
                
                if (result.errorCode === 0 && result.empList?.length > 0) {
                    const user = result.empList[0];
                    testUserId = user.openUserId;
                    updateProgress('userProgress', 100);
                    
                    showResult('userResult', 
                        `âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ!<br><strong>å§“å:</strong> ${user.name}<br><strong>ç”¨æˆ·ID:</strong> ${testUserId}<br><strong>éƒ¨é—¨:</strong> ${user.department?.name || 'æœªçŸ¥'}`, 'success');
                    
                    // å¯ç”¨æŸ¥è¯¢æŒ‰é’®
                    document.getElementById('queryNoFieldsBtn').disabled = false;
                    document.getElementById('queryBasicBtn').disabled = false;
                    log('ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼Œå¯ä»¥æŸ¥è¯¢æ•°æ®');
                } else {
                    throw new Error(`APIé”™è¯¯: ${result.errorMessage || 'ç”¨æˆ·ä¸å­˜åœ¨'} (${result.errorCode})`);
                }
            } catch (error) {
                updateProgress('userProgress', 0);
                log(`ç”¨æˆ·è·å–å¤±è´¥: ${error.message}`);
                showResult('userResult', `âŒ ç”¨æˆ·è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¸é™å­—æ®µæŸ¥è¯¢
        async function testQueryWithoutSearchFields() {
            const limit = parseInt(document.getElementById('limitInput').value) || 10;
            const offset = parseInt(document.getElementById('offsetInput').value) || 0;
            const status = document.getElementById('statusInput').value;
            
            if (!testToken || !testUserId) {
                log('è¯·å…ˆå®ŒæˆTokenè·å–å’Œç”¨æˆ·éªŒè¯');
                return;
            }
            
            log(`æ‰§è¡Œä¸é™å­—æ®µæŸ¥è¯¢: limit=${limit}, offset=${offset}, status=${status || 'å…¨éƒ¨'}`);
            updateProgress('queryProgress', 20);
            
            try {
                // æ„å»ºè¿‡æ»¤æ¡ä»¶
                const filters = [];
                if (status) {
                    filters.push({
                        field_name: "life_status",
                        field_values: [status],
                        operator: "EQ"
                    });
                }
                
                updateProgress('queryProgress', 40);
                
                const requestData = {
                    corpId: testCorpId,
                    corpAccessToken: testToken,
                    currentOpenUserId: testUserId,
                    data: {
                        dataObjectApiName: "on_site_signature__c",
                        search_query_info: {
                            limit: Math.min(limit, 100),
                            offset: offset,
                            filters: filters,
                            orders: [{fieldName: "create_time", isAsc: "false"}]
                        }
                    }
                };
                
                log(`è¯·æ±‚æ•°æ®: ${JSON.stringify(requestData, null, 2)}`);
                
                const response = await fetch(`${CONFIG.baseUrl}/cgi/crm/custom/v2/data/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    mode: 'cors'
                });
                
                updateProgress('queryProgress', 70);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`æŸ¥è¯¢å“åº”: ${JSON.stringify(result, null, 2)}`);
                
                if (result.errorCode === 0) {
                    // æå–æ•°æ® - æ ¹æ®çœŸå®APIå“åº”æ ¼å¼
                    let extractedData = [];
                    let total = 0;
                    
                    if (result.data && result.data.dataList && Array.isArray(result.data.dataList)) {
                        extractedData = result.data.dataList;
                        total = result.data.total || result.data.dataList.length;
                        log('âœ… æ£€æµ‹åˆ°dataListæ ¼å¼ï¼ˆç»´ä¿®å•æ ‡å‡†æ ¼å¼ï¼‰');
                    }
                    
                    testData = extractedData;
                    updateProgress('queryProgress', 100);
                    
                    console.log('æœ€ç»ˆæå–çš„testData:', testData);
                    console.log('testDataé•¿åº¦:', testData.length);
                    
                    if (testData.length > 0) {
                        console.log('ç¬¬ä¸€æ¡è®°å½•:', testData[0]);
                        console.log('ç¬¬ä¸€æ¡è®°å½•çš„å­—æ®µ:', Object.keys(testData[0]));
                    }
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºç»“æœ
                    let displayData = `<h5>ğŸ“Š æŸ¥è¯¢ç»“æœç»Ÿè®¡:</h5>`;
                    displayData += `<p><strong>APIæ€»è®°å½•æ•°:</strong> ${total}</p>`;
                    displayData += `<p><strong>å®é™…è¿”å›è®°å½•:</strong> ${testData.length}</p>`;
                    displayData += `<p><strong>æ•°æ®æå–æ–¹å¼:</strong> æ™ºèƒ½æ£€æµ‹APIå“åº”æ ¼å¼</p>`;
                    
                    if (testData.length > 0) {
                        const sample = testData[0];
                        const fieldCount = Object.keys(sample).length;
                        displayData += `<p><strong>è®°å½•å­—æ®µæ•°:</strong> ${fieldCount} ä¸ª</p>`;
                        
                        displayData += `<h5>ğŸ” å…³é”®æ•°æ®é¢„è§ˆ:</h5>`;
                        displayData += '<table style="width:100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; border: 1px solid #dee2e6;">';
                        
                        // æ˜¾ç¤ºå…³é”®å­—æ®µ
                        const keyFields = [
                            { key: 'name', label: 'ç»´ä¿®å•ç¼–å·' },
                            { key: 'life_status__r', label: 'ç”Ÿå‘½çŠ¶æ€', fallback: 'life_status' },
                            { key: 'owner__r', label: 'è´Ÿè´£äºº', fallback: 'owner' },
                            { key: 'create_time', label: 'åˆ›å»ºæ—¶é—´' },
                            { key: 'opportunity__c__r', label: 'å•†æœº', fallback: 'opportunity__c' },
                            { key: 'sales_floor__c__r', label: 'æ¡ˆåœº', fallback: 'sales_floor__c' },
                            { key: 'field_gKt1C__c', label: 'ç»´ä¿®é‡‘é¢' },
                            { key: 'field_eTwh1__c', label: 'è¯·æ¬¾é‡‘é¢' }
                        ];
                        
                        keyFields.forEach(field => {
                            let value = sample[field.key];
                            if (!value && field.fallback) {
                                value = sample[field.fallback];
                            }
                            
                            if (value !== undefined && value !== null && value !== '') {
                                // æ ¼å¼åŒ–å€¼
                                if (typeof value === 'object' && value !== null) {
                                    if (value.name) value = value.name;
                                    else if (Array.isArray(value)) {
                                        if (value.length === 1 && typeof value[0] === 'string') {
                                            value = value[0];
                                        } else {
                                            value = `${value.length} ä¸ªé¡¹ç›®`;
                                        }
                                    }
                                    else value = JSON.stringify(value).substring(0, 50) + '...';
                                }
                                
                                // æ—¶é—´æˆ³è½¬æ¢
                                if (field.key === 'create_time' && typeof value === 'number') {
                                    value = new Date(value).toLocaleString('zh-CN');
                                }
                                
                                displayData += `<tr style="border: 1px solid #ddd;">
                                    <td style="padding: 8px; background: #f8f9fa; font-weight: bold; width: 120px;">${field.label}</td>
                                    <td style="padding: 8px; word-break: break-all;">${value}</td>
                                </tr>`;
                            }
                        });
                        displayData += '</table>';
                        
                        displayData += `<p style="margin-top: 15px;"><em>ğŸ’¡ æ•°æ®åŒ…å« ${fieldCount} ä¸ªå­—æ®µï¼Œç‚¹å‡»"æ•°æ®æ¸…å•"æŸ¥çœ‹å®Œæ•´è¡¨æ ¼</em></p>`;
                    } else {
                        displayData += `<div class="warning">âš ï¸ APIè¿”å›äº†æ€»æ•° ${total}ï¼Œä½†å®é™…è®°å½•ä¸ºç©ºã€‚</div>`;
                    }
                    
                    showResult('queryResult', `âœ… æŸ¥è¯¢æˆåŠŸ!<br>${displayData}`, testData.length > 0 ? 'success' : 'warning');
                    
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('listBtn').disabled = testData.length === 0;
                    log(`âœ… æŸ¥è¯¢å®Œæˆ: APIæ€»æ•°${total}, å®é™…æå–${testData.length}æ¡è®°å½•`);
                } else {
                    throw new Error(`APIé”™è¯¯: ${result.errorMessage} (${result.errorCode})`);
                }
            } catch (error) {
                updateProgress('queryProgress', 0);
                log(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                showResult('queryResult', `âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŸºç¡€æŸ¥è¯¢
        async function testQueryBasic() {
            log('æ‰§è¡ŒåŸºç¡€æŸ¥è¯¢...');
            // å¯ä»¥å¤ç”¨ä¸é™å­—æ®µæŸ¥è¯¢çš„é€»è¾‘
            await testQueryWithoutSearchFields();
        }

        // æ˜¾ç¤ºæ•°æ®æ¸…å•
        function showDataList() {
            log('=== å¼€å§‹æ˜¾ç¤ºæ•°æ®æ¸…å• ===');
            log(`testDataç±»å‹: ${typeof testData}`);
            log(`testDataæ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(testData)}`);
            log(`testDataé•¿åº¦: ${testData ? testData.length : 'undefined'}`);
            
            if (!testData || !Array.isArray(testData) || testData.length === 0) {
                log('é”™è¯¯: æ²¡æœ‰æ•°æ®å¯æ˜¾ç¤º');
                showResult('queryResult', 'âŒ æ²¡æœ‰æ•°æ®å¯æ˜¾ç¤ºï¼Œè¯·å…ˆæ‰§è¡ŒæŸ¥è¯¢è·å–æ•°æ®', 'warning');
                return;
            }
            
            log(`æ•°æ®éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡æ˜¾ç¤º ${testData.length} æ¡è®°å½•`);
            
            // æ˜¾ç¤ºæ•°æ®æ¸…å•å¯¼èˆªæŒ‰é’®
            document.getElementById('dataListNavBtn').style.display = 'inline-block';
            
            // åˆ‡æ¢åˆ°æ•°æ®æ¸…å•é¡µé¢
            showSection('data-list');
            
            // æ¸²æŸ“æ•°æ®åˆ°è¡¨æ ¼
            renderDataListTable();
            
            log(`âœ… æ•°æ®æ¸…å•æ˜¾ç¤ºæˆåŠŸ: ${testData.length} æ¡è®°å½•`);
        }

        // æ¸²æŸ“æ•°æ®æ¸…å•è¡¨æ ¼
        function renderDataListTable() {
            const tableBody = document.getElementById('tableBody');
            const listSummary = document.getElementById('listSummary');
            
            if (!testData || testData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">æš‚æ— æ•°æ®</td></tr>';
                listSummary.textContent = 'æš‚æ— æ•°æ®';
                return;
            }
            
            // æ›´æ–°æ‘˜è¦
            listSummary.innerHTML = `å…± <strong>${testData.length}</strong> æ¡ç»´ä¿®å•è®°å½•`;
            
            // æ¸²æŸ“è¡¨æ ¼è¡Œ
            let html = '';
            testData.forEach((item, index) => {
                // æ ¼å¼åŒ–æ—¶é—´
                let createTime = '-';
                if (item.create_time) {
                    if (typeof item.create_time === 'number') {
                        createTime = new Date(item.create_time).toLocaleString('zh-CN');
                    } else {
                        createTime = item.create_time;
                    }
                }
                
                // æ ¼å¼åŒ–è´Ÿè´£äºº
                let owner = '-';
                if (item.owner__r && item.owner__r.name) {
                    owner = item.owner__r.name;
                } else if (item.owner && Array.isArray(item.owner) && item.owner.length > 0) {
                    owner = item.owner[0];
                }
                
                // æ ¼å¼åŒ–çŠ¶æ€
                let status = item.life_status__r || item.life_status || '-';
                
                // æ ¼å¼åŒ–é‡‘é¢
                let amount = '-';
                if (item.field_gKt1C__c) {
                    amount = `Â¥${parseFloat(item.field_gKt1C__c).toLocaleString()}`;
                }
                
                html += `<tr style="border-bottom: 1px solid #e9ecef;">
                    <td style="padding: 12px 8px; text-align: center;">${index + 1}</td>
                    <td style="padding: 12px 8px;"><strong>${item.name || '-'}</strong></td>
                    <td style="padding: 12px 8px;">
                        <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; 
                                     background: ${status === 'æ­£å¸¸' ? '#d4edda' : '#fff3cd'}; 
                                     color: ${status === 'æ­£å¸¸' ? '#155724' : '#856404'};">
                            ${status}
                        </span>
                    </td>
                    <td style="padding: 12px 8px; font-size: 11px;">${createTime}</td>
                    <td style="padding: 12px 8px;">${owner}</td>
                    <td style="padding: 12px 8px; max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${item.opportunity__c__r || item.opportunity__c || ''}">${item.opportunity__c__r || item.opportunity__c || '-'}</td>
                    <td style="padding: 12px 8px; max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="${item.sales_floor__c__r || item.sales_floor__c || ''}">${item.sales_floor__c__r || item.sales_floor__c || '-'}</td>
                    <td style="padding: 12px 8px; text-align: right; font-family: 'Courier New', monospace;">${amount}</td>
                    <td style="padding: 12px 8px; text-align: center;">
                        <button onclick="viewItemDetails(${index})" style="padding: 4px 8px; font-size: 11px; background: #17a2b8; border: none; color: white; border-radius: 4px; cursor: pointer; margin-right: 4px;">è¯¦æƒ…</button>
                        <button onclick="editItem(${index})" style="padding: 4px 8px; font-size: 11px; background: #28a745; border: none; color: white; border-radius: 4px; cursor: pointer;">ç¼–è¾‘</button>
                    </td>
                </tr>`;
            });
            
            tableBody.innerHTML = html;
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewItemDetails(index) {
            if (!testData || index >= testData.length) return;
            
            const item = testData[index];
            let detailsHTML = '<div style="max-height: 400px; overflow-y: auto; padding: 10px;">';
            detailsHTML += `<h4>ç»´ä¿®å•è¯¦æƒ…: ${item.name || 'æœªçŸ¥ç¼–å·'}</h4>`;
            
            // åŸºç¡€ä¿¡æ¯
            detailsHTML += '<h5>åŸºç¡€ä¿¡æ¯</h5>';
            detailsHTML += `<p><strong>ç¼–å·:</strong> ${item.name || '-'}</p>`;
            detailsHTML += `<p><strong>çŠ¶æ€:</strong> ${item.life_status__r || item.life_status || '-'}</p>`;
            if (item.create_time) {
                const createTime = typeof item.create_time === 'number' ? 
                    new Date(item.create_time).toLocaleString('zh-CN') : item.create_time;
                detailsHTML += `<p><strong>åˆ›å»ºæ—¶é—´:</strong> ${createTime}</p>`;
            }
            if (item.owner__r) {
                detailsHTML += `<p><strong>è´Ÿè´£äºº:</strong> ${item.owner__r.name}</p>`;
            }
            
            // ä¸šåŠ¡ä¿¡æ¯
            detailsHTML += '<h5>ä¸šåŠ¡ä¿¡æ¯</h5>';
            if (item.opportunity__c__r) detailsHTML += `<p><strong>å•†æœº:</strong> ${item.opportunity__c__r}</p>`;
            if (item.sales_floor__c__r) detailsHTML += `<p><strong>æ¡ˆåœº:</strong> ${item.sales_floor__c__r}</p>`;
            if (item.building_type__c) detailsHTML += `<p><strong>æ ‹åˆ«:</strong> ${item.building_type__c}</p>`;
            if (item.customer_type__c) detailsHTML += `<p><strong>æˆ·åˆ«:</strong> ${item.customer_type__c}</p>`;
            if (item.floor_level__c) detailsHTML += `<p><strong>æ¥¼å±‚:</strong> ${item.floor_level__c}</p>`;
            
            // é‡‘é¢ä¿¡æ¯
            if (item.field_gKt1C__c || item.field_eTwh1__c) {
                detailsHTML += '<h5>é‡‘é¢ä¿¡æ¯</h5>';
                if (item.field_gKt1C__c) detailsHTML += `<p><strong>ç»´ä¿®é‡‘é¢:</strong> Â¥${parseFloat(item.field_gKt1C__c).toLocaleString()}</p>`;
                if (item.field_eTwh1__c) detailsHTML += `<p><strong>è¯·æ¬¾é‡‘é¢:</strong> Â¥${parseFloat(item.field_eTwh1__c).toLocaleString()}</p>`;
            }
            
            // å¤šåª’ä½“ä¿¡æ¯
            detailsHTML += '<h5>å¤šåª’ä½“ä¿¡æ¯</h5>';
            const signCount = (item.field_iSwte__c && Array.isArray(item.field_iSwte__c)) ? item.field_iSwte__c.length : 0;
            const photoCount = (item.field_xZj3E__c && Array.isArray(item.field_xZj3E__c)) ? item.field_xZj3E__c.length : 0;
            const videoCount = (item.video__c && Array.isArray(item.video__c)) ? item.video__c.length : 0;
            
            detailsHTML += `<p><strong>ç­¾å:</strong> ${signCount > 0 ? `${signCount} ä¸ªç­¾å` : 'æ— ç­¾å'}</p>`;
            detailsHTML += `<p><strong>ç…§ç‰‡:</strong> ${photoCount > 0 ? `${photoCount} å¼ ç…§ç‰‡` : 'æ— ç…§ç‰‡'}</p>`;
            detailsHTML += `<p><strong>è§†é¢‘:</strong> ${videoCount > 0 ? `${videoCount} ä¸ªè§†é¢‘` : 'æ— è§†é¢‘'}</p>`;
            
            detailsHTML += '</div>';
            
            showResult('queryResult', detailsHTML, 'success');
            log(`æŸ¥çœ‹è¯¦æƒ…: ${item.name || index}`);
        }

        // å¯¼å‡ºæ•°æ®
        function testExport() {
            if (!testData || testData.length === 0) {
                log('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            try {
                // æ ¼å¼åŒ–æ•°æ®
                const exportData = testData.map(record => {
                    const formatted = {};
                    
                    // åŸºç¡€å­—æ®µ
                    formatted['ç»´ä¿®å•ç¼–å·'] = record.name || '';
                    formatted['ç”Ÿå‘½çŠ¶æ€'] = record.life_status__r || record.life_status || '';
                    formatted['è´Ÿè´£äºº'] = record.owner__r ? record.owner__r.name : (Array.isArray(record.owner) ? record.owner[0] : record.owner || '');
                    formatted['åˆ›å»ºæ—¶é—´'] = record.create_time ? (typeof record.create_time === 'number' ? new Date(record.create_time).toLocaleString('zh-CN') : record.create_time) : '';
                    formatted['å•†æœº'] = record.opportunity__c__r || record.opportunity__c || '';
                    formatted['æ¡ˆåœº'] = record.sales_floor__c__r || record.sales_floor__c || '';
                    formatted['æ ‹åˆ«'] = record.building_type__c || '';
                    formatted['æˆ·åˆ«'] = record.customer_type__c || '';
                    formatted['æ¥¼å±‚'] = record.floor_level__c || '';
                    formatted['ç»´ä¿®é‡‘é¢'] = record.field_gKt1C__c || '';
                    formatted['è¯·æ¬¾é‡‘é¢'] = record.field_eTwh1__c || '';
                    
                    // å¤šåª’ä½“å­—æ®µ
                    formatted['ç­¾åæ•°é‡'] = (record.field_iSwte__c && Array.isArray(record.field_iSwte__c)) ? record.field_iSwte__c.length : 0;
                    formatted['ç…§ç‰‡æ•°é‡'] = (record.field_xZj3E__c && Array.isArray(record.field_xZj3E__c)) ? record.field_xZj3E__c.length : 0;
                    formatted['è§†é¢‘æ•°é‡'] = (record.video__c && Array.isArray(record.video__c)) ? record.video__c.length : 0;
                    
                    return formatted;
                });
                
                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç»´ä¿®å•æ•°æ®_${new Date().toISOString().slice(0,19).replace(/[:.]/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                log(`å¯¼å‡ºæˆåŠŸ: ${testData.length} æ¡è®°å½•ï¼Œæ–‡ä»¶: ${a.download}`);
                
                showResult('queryResult', `âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼<br>æ–‡ä»¶å: ${a.download}<br>è®°å½•æ•°: ${testData.length}`, 'success');
            } catch (error) {
                log(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
                showResult('queryResult', `âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è°ƒè¯•æ•°æ®å‡½æ•°
        function debugData() {
            log('=== æ•°æ®è°ƒè¯•ä¿¡æ¯ ===');
            
            log(`testToken: ${testToken ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
            log(`testCorpId: ${testCorpId || 'æœªè®¾ç½®'}`);
            log(`testUserId: ${testUserId || 'æœªè®¾ç½®'}`);
            log(`testDataç±»å‹: ${typeof testData}`);
            log(`testDataæ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(testData)}`);
            log(`testDataé•¿åº¦: ${testData ? testData.length : 'undefined'}`);
            
            if (testData && testData.length > 0) {
                log('testDataç¬¬ä¸€æ¡è®°å½•:');
                console.log(testData[0]);
                
                log('ç¬¬ä¸€æ¡è®°å½•çš„æ‰€æœ‰å­—æ®µ:');
                Object.keys(testData[0]).forEach(key => {
                    const value = testData[0][key];
                    log(`  ${key}: ${typeof value} = ${JSON.stringify(value).substring(0, 100)}`);
                });
            }
            
            let debugHTML = '<h4>ğŸ”§ æ•°æ®è°ƒè¯•ä¿¡æ¯</h4>';
            debugHTML += `<p><strong>TokençŠ¶æ€:</strong> ${testToken ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}</p>`;
            debugHTML += `<p><strong>ç”¨æˆ·ID:</strong> ${testUserId || 'âŒ æœªè®¾ç½®'}</p>`;
            debugHTML += `<p><strong>æ•°æ®çŠ¶æ€:</strong> ${testData ? `âœ… æ•°ç»„ï¼Œé•¿åº¦ ${testData.length}` : 'âŒ æœªå®šä¹‰'}</p>`;
            
            if (testData && testData.length > 0) {
                debugHTML += '<h5>ç¬¬ä¸€æ¡è®°å½•å­—æ®µ:</h5><ul>';
                Object.keys(testData[0]).slice(0, 10).forEach(key => {
                    debugHTML += `<li><strong>${key}:</strong> ${typeof testData[0][key]}</li>`;
                });
                debugHTML += '</ul>';
            }
            
            showResult('queryResult', debugHTML, 'warning');
        }

        // ç¼–è¾‘æ¡ç›®
        function editItem(index) {
            if (!testData || index >= testData.length) {
                log('ç¼–è¾‘å¤±è´¥ï¼šæ— æ•ˆçš„ç´¢å¼•');
                return;
            }
            
            currentEditIndex = index;
            const item = testData[index];
            originalData = JSON.parse(JSON.stringify(item)); // æ·±æ‹·è´åŸå§‹æ•°æ®
            
            log(`å¼€å§‹ç¼–è¾‘ç»´ä¿®å•: ${item.name || index}`);
            
            // ç”Ÿæˆç¼–è¾‘è¡¨å•
            generateEditForm(item);
            
            // æ˜¾ç¤ºç¼–è¾‘å¼¹çª—
            document.getElementById('editModal').style.display = 'block';
        }

        // ç”Ÿæˆç¼–è¾‘è¡¨å•
        function generateEditForm(item) {
            const editForm = document.getElementById('editForm');
            
            // å®šä¹‰å¯ç¼–è¾‘çš„å­—æ®µ
            const editableFields = [
                { key: 'building_type__c', label: 'æ ‹åˆ«', type: 'text', placeholder: 'ä¾‹å¦‚ï¼šAã€Bã€C' },
                { key: 'customer_type__c', label: 'æˆ·åˆ«', type: 'text', placeholder: 'ä¾‹å¦‚ï¼šA1ã€B2ã€C3' },
                { key: 'floor_level__c', label: 'æ¥¼å±‚', type: 'text', placeholder: 'ä¾‹å¦‚ï¼š1Fã€2Fã€3F' },
                { key: 'field_gKt1C__c', label: 'ç»´ä¿®é‡‘é¢', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢ï¼Œä¾‹å¦‚ï¼š1500.00' },
                { key: 'field_eTwh1__c', label: 'è¯·æ¬¾é‡‘é¢', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢ï¼Œä¾‹å¦‚ï¼š2000.00' },
                { key: 'field_JmGkC__c', label: 'ç»´ä¿®çŠ¶å†µ', type: 'textarea', placeholder: 'æè¿°ç»´ä¿®è¯¦ç»†çŠ¶å†µ...' },
                { key: 'life_status', label: 'ç”Ÿå‘½çŠ¶æ€', type: 'select', options: ['normal', 'draft', 'invalid'], 
                  optionLabels: { 'normal': 'æ­£å¸¸', 'draft': 'è‰ç¨¿', 'invalid': 'ä½œåºŸ' } }
            ];
            
            let formHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h5>ğŸ“ ç¼–è¾‘ç»´ä¿®å•ï¼š${item.name || 'æœªçŸ¥ç¼–å·'}</h5>
                    <p style="margin: 5px 0; color: #6c757d;">è®°å½•ID: ${item._id}</p>
                </div>
            `;
            
            editableFields.forEach(field => {
                const currentValue = item[field.key] || '';
                
                formHTML += `<div style="margin-bottom: 15px;">`;
                formHTML += `<label style="display: block; font-weight: 600; margin-bottom: 5px; color: #495057;">${field.label}:</label>`;
                
                if (field.type === 'select') {
                    formHTML += `<select id="edit_${field.key}" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">`;
                    field.options.forEach(option => {
                        const label = field.optionLabels ? field.optionLabels[option] : option;
                        const selected = currentValue === option ? 'selected' : '';
                        formHTML += `<option value="${option}" ${selected}>${label}</option>`;
                    });
                    formHTML += `</select>`;
                } else if (field.type === 'textarea') {
                    formHTML += `<textarea id="edit_${field.key}" rows="3" placeholder="${field.placeholder}" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical;">${currentValue}</textarea>`;
                } else {
                    formHTML += `<input type="${field.type}" id="edit_${field.key}" value="${currentValue}" placeholder="${field.placeholder}" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">`;
                }
                formHTML += `</div>`;
            });
            
            // æ·»åŠ æç¤ºä¿¡æ¯
            formHTML += `
                <div style="margin-top: 20px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 13px;">
                    <strong>ğŸ’¡ ç¼–è¾‘æç¤ºï¼š</strong>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>ä¿®æ”¹åç‚¹å‡»"ä¿å­˜ä¿®æ”¹"æŒ‰é’®æäº¤åˆ°æœåŠ¡å™¨</li>
                        <li>é‡‘é¢å­—æ®µè¯·è¾“å…¥æ•°å­—ï¼Œæ”¯æŒå°æ•°ç‚¹</li>
                        <li>çŠ¶æ€ä¿®æ”¹ä¼šå½±å“ç»´ä¿®å•çš„ç”Ÿå‘½å‘¨æœŸ</li>
                    </ul>
                </div>
            `;
            
            editForm.innerHTML = formHTML;
        }

        // ä¿å­˜ä¿®æ”¹
        async function saveChanges() {
            if (currentEditIndex < 0 || !testData[currentEditIndex]) {
                log('ä¿å­˜å¤±è´¥ï¼šæ— æ•ˆçš„ç¼–è¾‘çŠ¶æ€');
                return;
            }
            
            const item = testData[currentEditIndex];
            log(`å¼€å§‹ä¿å­˜ç»´ä¿®å•ä¿®æ”¹: ${item.name}`);
            
            // æ”¶é›†è¡¨å•æ•°æ®
            const updatedData = {};
            const editableFields = ['building_type__c', 'customer_type__c', 'floor_level__c', 'field_gKt1C__c', 'field_eTwh1__c', 'field_JmGkC__c', 'life_status'];
            
            let hasChanges = false;
            editableFields.forEach(fieldKey => {
                const inputElement = document.getElementById(`edit_${fieldKey}`);
                if (inputElement) {
                    let newValue = inputElement.value.trim();
                    
                    // æ•°å­—å­—æ®µç‰¹æ®Šå¤„ç†
                    if (fieldKey.includes('__c') && (fieldKey.includes('field_g') || fieldKey.includes('field_e'))) {
                        if (newValue && !isNaN(newValue)) {
                            newValue = parseFloat(newValue).toFixed(2);
                        }
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
                    const oldValue = originalData[fieldKey] || '';
                    if (newValue !== oldValue.toString()) {
                        updatedData[fieldKey] = newValue;
                        hasChanges = true;
                        log(`å­—æ®µå˜åŒ–: ${fieldKey} = "${oldValue}" -> "${newValue}"`);
                    }
                }
            });
            
            if (!hasChanges) {
                showEditResult('âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜åŒ–', 'warning');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showEditResult('ğŸ”„ æ­£åœ¨ä¿å­˜ä¿®æ”¹...', 'info');
            
            try {
                // æ„å»ºAPIè¯·æ±‚æ•°æ®
                const requestData = {
                    corpAccessToken: testToken,
                    corpId: testCorpId,
                    currentOpenUserId: testUserId,
                    data: {
                        object_data: {
                            _id: item._id,
                            dataObjectApiName: "on_site_signature__c",
                            ...updatedData
                        },
                        details: {}
                    }
                };
                
                log(`æ›´æ–°è¯·æ±‚æ•°æ®: ${JSON.stringify(requestData, null, 2)}`);
                
                // è°ƒç”¨æ›´æ–°API
                const response = await fetch(`${CONFIG.baseUrl}/cgi/crm/custom/v2/data/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log(`æ›´æ–°å“åº”: ${JSON.stringify(result, null, 2)}`);
                
                if (result.errorCode === 0) {
                    // æ›´æ–°æˆåŠŸ
                    showEditResult('âœ… ä¿®æ”¹ä¿å­˜æˆåŠŸï¼', 'success');
                    
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    Object.keys(updatedData).forEach(key => {
                        testData[currentEditIndex][key] = updatedData[key];
                    });
                    
                    // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
                    renderDataListTable();
                    
                    log(`âœ… ç»´ä¿®å• ${item.name} ä¿®æ”¹æˆåŠŸ`);
                    
                    // 3ç§’åè‡ªåŠ¨å…³é—­å¼¹çª—
                    setTimeout(() => {
                        closeEditModal();
                    }, 2000);
                    
                } else {
                    throw new Error(`APIé”™è¯¯: ${result.errorMessage} (${result.errorCode})`);
                }
                
            } catch (error) {
                log(`ä¿å­˜å¤±è´¥: ${error.message}`);
                showEditResult(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘ç»“æœ
        function showEditResult(message, type) {
            const editResult = document.getElementById('editResult');
            let className = '';
            
            switch (type) {
                case 'success':
                    className = 'success';
                    break;
                case 'error':
                    className = 'error';
                    break;
                case 'warning':
                    className = 'warning';
                    break;
                default:
                    className = '';
            }
            
            editResult.innerHTML = `<div class="result ${className}" style="margin: 0; padding: 10px;">${message}</div>`;
        }

        // å…³é—­ç¼–è¾‘å¼¹çª—
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editResult').innerHTML = '';
            currentEditIndex = -1;
            originalData = {};
            log('ç¼–è¾‘å¼¹çª—å·²å…³é—­');
        }

        // æ‰¹é‡ç¼–è¾‘åŠŸèƒ½
        function batchEdit() {
            if (!testData || testData.length === 0) {
                log('æ‰¹é‡ç¼–è¾‘å¤±è´¥ï¼šæ²¡æœ‰æ•°æ®');
                return;
            }
            
            // è¿™é‡Œå¯ä»¥å®ç°æ‰¹é‡ç¼–è¾‘åŠŸèƒ½
            log('æ‰¹é‡ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
            showResult('queryResult', 'ğŸ“ æ‰¹é‡ç¼–è¾‘åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼', 'warning');
        }
        function clearDataList() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ•°æ®æ¸…å•å—ï¼Ÿ')) {
                testData = [];
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">æš‚æ— æ•°æ®</td></tr>';
                document.getElementById('listSummary').textContent = 'æš‚æ— æ•°æ®';
                document.getElementById('dataListNavBtn').style.display = 'none';
                log('æ•°æ®æ¸…å•å·²æ¸…ç©º');
            }
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').textContent = 'æ—¥å¿—å·²æ¸…é™¤...\n';
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('çº·äº«é”€å®¢APIåœ¨çº¿æµ‹è¯•å·¥å…·å·²åŠ è½½');
            log('æµ‹è¯•å·¥å…·åˆå§‹åŒ–å®Œæˆï¼Œè¯·æŒ‰æ­¥éª¤è¿›è¡ŒAPIæµ‹è¯•');
            
            // ç¡®ä¿é»˜è®¤æ˜¾ç¤ºæ¦‚è¿°é¡µé¢
            showSection('overview');
        });
    </script>
</body>
</html>