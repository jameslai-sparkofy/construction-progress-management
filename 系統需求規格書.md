# 工程進度管理系統 - 需求規格書

## 專案概述
建立一個基於紛享銷客CRM的多租戶工程進度管理系統，每個商機（專案）都有獨立的網站和後台，讓外部協作人員（工班、業主）能夠查看和更新工程進度，部署在Cloudflare上。

**核心特色**：
- 每個商機獨立網站，擁有專屬URL和後台
- 動態權限配置，不同角色看到不同欄位
- 安全URL設計，防止未授權訪問
- 無需修改紛享銷客，所有新欄位在CRM端新增

## 系統架構
- **前端**：Vue 3 + Vite + Element Plus
- **後端**：Cloudflare Workers（多租戶路由）
- **資料來源**：紛享銷客CRM API
- **部署平台**：Cloudflare Pages + Workers
- **存儲**：Cloudflare KV（商機配置、用戶Session）
- **簡訊服務**：Twilio 或 三竹資訊（待選擇）

## 功能需求

### 1. 多租戶架構
- **商機網站**：每個商機（專案）獨立網站
  - 專屬網址（如：progress.yourcompany.com/xinganxi-abc123def456/）
  - 安全URL設計：`{專案名稱}-{12位隨機token}`
  - 獨立的後台管理
  - 自定義欄位權限配置
- **超級管理後台**：
  - 商機管理（創建/刪除網站）
  - 全局設定
  - 系統監控
- **URL安全性**：
  - 隨機token防止URL被猜測
  - 只有授權用戶才能訪問
  - Token由系統自動生成

### 2. 權限管理
- **多層級權限**：不同使用者角色有不同的查看和編輯權限
  - 工班：可編輯維修狀況、上傳照片等
  - 業主：可編輯驗收簽名、意見等
  - 管理員：完整權限
- **動態權限配置**：
  - 每個商機可自定義欄位權限
  - 權限類型：隱藏/只讀/可編輯
  - 後台配置介面
- **登入系統**：
  - 使用手機號碼登入
  - 整合簡訊驗證（OTP）
  - Session管理

### 3. 數據展示
- **數據類型**：
  - 維修單（依商機篩選）
  - 跟進記錄
  - 案場資訊
- **即時更新**：使用SSE或輪詢機制實現即時數據更新
- **統計報表**：
  - 工程進度圖表（響應式）
  - 維修狀態統計
  - 金額統計報表
  - 時間趨勢分析
- **RWD數據展示**：
  - 手機版：卡片式列表，重點資訊優先顯示
  - 平板版：網格佈局，適中資訊密度
  - 電腦版：完整表格，所有欄位顯示

### 4. 功能需求
- **查看功能**：
  - 依權限查看相關資料
  - 搜尋和篩選功能
  - 詳細資料檢視
- **提交功能**：
  - 工班可填寫欄位（依商機配置）
  - 業主可填寫欄位（依商機配置）
  - 表單驗證
  - 提交確認機制
- **通知功能**：暫不實作

### 5. 安全考量
- **API密鑰保護**：
  - 使用Cloudflare Workers存儲敏感資訊
  - 環境變數管理
  - API請求代理
- **訪問控制**：
  - JWT Token驗證
  - Session超時管理
  - 商機隔離
  - Rate limiting

## 欄位權限對照表（根據API分析）

### 現有維修單欄位
1. **基本資訊**
   - `name`: 維修單編號（系統自動生成）
   - `life_status`: 生命狀態（正常/作廢）
   - `create_time`: 創建時間
   - `owner`: 負責人

2. **工程資訊**
   - `building_type__c`: 棟別（如：B、C）
   - `customer_type__c`: 戶別（如：B1、B5、C6）
   - `floor_level__c`: 樓層
   - `field_JmGkC__c`: 維修狀況描述
   - `shift_time__c`: 工班名稱

3. **金額資訊**
   - `field_gKt1C__c`: 維修金額
   - `field_eTwh1__c`: 請款金額
   - `field_u4zjb__c`: 面積（坪數）

4. **多媒體資料**
   - `field_xZj3E__c`: 照片
   - `field_iSwte__c`: 簽名
   - `video__c`: 視頻

5. **關聯資訊**
   - `opportunity__c`: 商機（專案）
   - `sales_floor__c`: 案場
   - `corresponding_ticket__c`: 對應工單

### 建議權限分配

#### 工班可編輯欄位：
- `field_JmGkC__c`: 維修狀況描述
- `field_xZj3E__c`: 上傳施工照片
- `video__c`: 上傳施工視頻
- 新增：施工進度百分比
- 新增：材料使用清單
- 新增：遇到的問題描述

#### 業主可編輯欄位：
- `field_iSwte__c`: 驗收簽名
- 新增：滿意度評分
- 新增：驗收意見
- 新增：付款確認狀態

#### 兩者都可查看但不能編輯：
- 所有基本資訊
- 工程資訊（棟別、戶別、樓層）
- 金額資訊
- 負責人資訊

## 已確認事項
1. ✅ **不新增欄位**：所有新欄位在紛享銷客CRM端新增
2. ✅ **工班名單**：維持文字欄位，不改成下拉選單
3. ✅ **通知功能**：暫不實作，未來可擴展
4. ✅ **URL結構**：路徑模式 + 隨機token
5. ✅ **權限管理**：動態配置，三種權限（隱藏/只讀/可編輯）
6. ✅ **API連接**：已測試成功，可正常查詢維修單數據
7. ✅ **離線功能**：不需要
8. ✅ **多語言支援**：不需要
9. ✅ **RWD響應式設計**：非常重要，需支援手機/平板/電腦

## 待確認事項
1. 簡訊服務商選擇？（Twilio 或 三竹資訊）
2. 數據保留期限？

## URL結構示例

```
# 主網站
progress.yourcompany.com/                           # 首頁（商機列表）
progress.yourcompany.com/admin/                     # 超級管理後台

# 興安西專案（token: abc123def456）
progress.yourcompany.com/xinganxi-abc123def456/           # 前台查詢頁面
progress.yourcompany.com/xinganxi-abc123def456/admin/     # 專案後台
progress.yourcompany.com/xinganxi-abc123def456/login/     # 登入頁面
progress.yourcompany.com/xinganxi-abc123def456/api/       # API端點

# 市鎮南專案（token: xyz789uvw012）
progress.yourcompany.com/shizhennan-xyz789uvw012/         # 前台查詢頁面
progress.yourcompany.com/shizhennan-xyz789uvw012/admin/   # 專案後台
```

## 技術實現方案

### 前端方案
- **Framework**: Vue 3 + Vite
- **UI框架**: Element Plus（內建RWD支援）
- **狀態管理**: Pinia
- **圖表庫**: ECharts（響應式圖表）
- **樣式**: TailwindCSS + Element Plus
- **構建工具**: Vite
- **RWD策略**: 
  - 手機優先設計（Mobile First）
  - 支援斷點：手機(<=768px)、平板(768-1024px)、電腦(>=1024px)
  - 觸控友好的按鈕和表單
  - 適配不同螢幕尺寸的圖表和表格

### 後端方案
- **運行環境**: Cloudflare Workers
- **數據存儲**: Cloudflare KV
- **文件存儲**: 紛享銷客文件系統
- **即時更新**: Server-Sent Events (SSE)

### API整合
- 紛享銷客API代理（保護密鑰）
- 請求快取策略（提升性能）
- 錯誤處理和重試機制
- 權限過濾（根據角色返回數據）

## 開發階段

### Phase 1: 多租戶基礎架構（1-2週）
- [ ] Cloudflare Workers多租戶路由
- [ ] 商機識別和配置系統
- [ ] 基礎API代理層
- [ ] KV存儲結構設計

### Phase 2: 超級管理後台（1週）
- [ ] 商機管理介面
- [ ] 權限配置系統
- [ ] 用戶管理功能
- [ ] 基礎報表

### Phase 3: 商機網站前台（2週）
- [ ] 登入系統（手機號+OTP）
- [ ] 維修單查詢和展示
- [ ] 權限控制編輯功能
- [ ] RWD響應式設計
  - [ ] 手機版介面（卡片式）
  - [ ] 平板版介面（網格式）
  - [ ] 電腦版介面（表格式）
- [ ] 觸控友好的互動設計

### Phase 4: 優化和測試（1週）
- [ ] 性能優化
- [ ] 安全測試
- [ ] 多商機測試
- [ ] 使用者測試

## 更新日誌
- 2025-01-16: 初始版本，記錄基本需求
- 2025-01-16: 調整為多租戶架構，每個商機獨立網站
- 2025-01-16: 移除通知功能，改為動態權限配置系統
- 2025-01-16: 新增URL安全設計（隨機token）
- 2025-01-16: 確認技術需求：不要離線功能和多語言，強調RWD響應式設計